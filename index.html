<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶ß‡ßÇ‡¶Æ‡¶ï‡ßá‡¶§‡ßÅ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* --- THEME --- */
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3;
            --bg: #f3f4f6; --surface: #ffffff; --text: #1f2937; --text-light: #6b7280;
            --border: #e5e7eb; --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; font-size: 15px; }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .flex-between { justify-content: space-between; }
        .flex-col { flex-direction: column; }
        .gap-2 { gap: 0.5rem; } .w-full { width: 100%; }
        .text-center { text-align: center; } .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.85rem; } .text-xs { font-size: 0.75rem; }
        .text-primary { color: var(--primary); } .text-danger { color: #ef4444; } 
        .text-success { color: #10b981; } .text-light { color: var(--text-light); }
        .text-warning { color: #f59e0b; }
        .mb-2 { margin-bottom: 0.5rem; } .mb-4 { margin-bottom: 1rem; } .mt-2 { margin-top: 0.5rem; }
        .p-4 { padding: 1rem; }
        
        /* Additional utility classes */
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .bg-indigo-50 { background: #eef2ff; }
        .border-indigo-100 { border-color: #e0e7eb; }
        .bg-gray-50 { background: #f9fafb; }
        .bg-gray-100 { background: #f3f4f6; }
        .bg-white\/20 { background: rgba(255, 255, 255, 0.2); }
        .fixed { position: fixed; }
        .bottom-0 { bottom: 0; }
        .left-0 { left: 0; }
        .right-0 { right: 0; }
        .w-auto { width: auto; }
        .w-1\/3 { width: 33.333%; }
        .w-2\/3 { width: 66.666%; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .relative { position: relative; }

        /* --- COMPONENTS --- */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px;
            font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: #ef4444; } .btn-success { background: #10b981; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }

        .card { background: var(--surface); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 12px; border: 1px solid var(--border); }
        
        /* Input & Password Toggle */
        .input-group { position: relative; margin-bottom: 10px; }
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px;
            background: #f9fafb; font-size: 1rem; outline: none; margin-bottom: 10px;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; }
        .pass-toggle { position: absolute; right: 12px; top: 12px; color: var(--text-light); cursor: pointer; }

        /* --- MARQUEE --- */
        .marquee-container { background: var(--primary); color: white; overflow: hidden; white-space: nowrap; height: 35px; display: flex; align-items: center; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: scroll 20s linear infinite; font-weight: 600; font-size: 0.9rem; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- AUTH & MODAL --- */
        #authScreen, .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #authScreen { background: linear-gradient(135deg, var(--primary), #818cf8); }
        .modal { align-items: flex-end; z-index: 3000; background: rgba(0,0,0,0.5); }
        .auth-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- NAVBAR --- */
        .navbar { position: sticky; top: 0; background: var(--surface); padding: 10px 16px; border-bottom: 1px solid var(--border); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .nav-brand { font-size: 1.2rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; z-index: 1000; padding-bottom: max(8px, env(safe-area-inset-bottom)); }
        .nav-item { background: none; border: none; color: var(--text-light); font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 4px; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-item i { font-size: 1.2rem; }

        /* EXAM & Q */
        .q-img { max-width: 100%; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ddd; }
        .timer-bar { position: sticky; top: 0; background: white; padding: 10px; z-index: 10; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; font-weight: bold; }
        .mcq-opt { padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 5px; display: flex; gap: 10px; cursor: pointer; }
        .mcq-opt.selected { background: #e0e7ff; border-color: var(--primary); }
        .mcq-opt input[type="radio"] { margin-right: 8px; }
        
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .st-Pending { background: #fef3c7; color: #d97706; }
        .st-Approved { background: #dcfce7; color: #16a34a; }
        .st-Rejected { background: #fee2e2; color: #dc2626; }

        /* --- UI ELEMENTS --- */
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin: 0 auto 10px; display: block; background: #e0e7ff; }
        .profile-pic-small { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); background: #e0e7ff; }
        .post-img { width: 100%; height: auto; border-radius: 8px; margin-top: 8px; max-height: 300px; object-fit: cover; }
        
        .msg-box { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .admin-reply { background: #e0e7ff; padding: 8px; border-radius: 6px; margin-top: 5px; font-size: 0.9rem; border-left: 3px solid var(--primary); }

        .overflow-x-auto { overflow-x: auto; }
        .pb-2 { padding-bottom: 0.5rem; }

        /* Logout Button Style */
        .logout-btn-nav { font-size: 1.2rem; color: #ef4444; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s; }
        .logout-btn-nav:hover { background: #fee2e2; }
        
        /* Image styling */
        .w-8 { width: 32px; }
        .h-8 { height: 32px; }
        .rounded-full { border-radius: 50%; }
        .object-cover { object-fit: cover; }
        
        /* Exam modal specific */
        #modal-exam .modal-content { border-radius: 0; max-width: 100%; height: 100%; }
        
        /* Admin Student Card */
        .student-card { padding: 12px; border-bottom: 1px solid #eee; }
        .student-card:last-child { border-bottom: none; }
        .class-badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; }
        
        /* Marks styling */
        .marks-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .marks-high { background: #dcfce7; color: #16a34a; border: 2px solid #bbf7d0; }
        .marks-medium { background: #fef3c7; color: #d97706; border: 2px solid #fde68a; }
        .marks-low { background: #fee2e2; color: #dc2626; border: 2px solid #fecaca; }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
/* --- FILTER STYLES --- */
.filter-btn {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--primary);
    background: transparent;
    color: var(--primary);
    white-space: nowrap;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}
.filter-btn.active {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3);
}
.filter-btn:hover {
    background: #e0e7ff;
}
.filter-btn.active:hover {
    background: var(--primary-dark);
}
.post-cat-badge {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: bold;
    background: #eef2ff;
    color: var(--primary);
    padding: 2px 8px;
    border-radius: 4px;
    margin-bottom: 5px;
    border: 1px solid #c7d2fe;
}

        /* --- NEW STYLES FOR EXPANDABLE POSTS --- */
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            cursor: pointer;
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .post-content {
            padding: 0 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .post-content.expanded {
            max-height: 5000px;
            padding: 12px;
        }

        .translate-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 8px;
            display: inline-block;
            vertical-align: middle;
        }

        .translate-btn:hover {
            background: #0da271;
        }

        .post-translation {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .post-translation.show {
            display: block;
        }

        .post-title-wrapper {
            flex: 1;
        }

        .post-date {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        .post-expand-icon {
            color: var(--text-light);
            transition: transform 0.3s;
            margin-left: 10px;
            min-width: 20px;
        }

        .post-expand-icon.expanded {
            transform: rotate(180deg);
        }
/* --- DETAILED EXAM CARD --- */
/* --- ADVANCED EXAM CARD v2 --- */
.exam-card-adv {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 20px;
    border: 1px solid #f1f5f9;
    overflow: hidden;
    position: relative;
}

/* Header */
.ec-header {
    padding: 12px 15px;
    background: #f8fafc;
    border-bottom: 1px dashed #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.ec-badge { font-size: 0.7rem; padding: 3px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.ec-upcoming { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
.ec-live { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; animation: pulse 1.5s infinite; }
.ec-ended { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }

/* Body */
.ec-body { padding: 15px; }
.ec-title { font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 5px; }
.ec-sub { font-size: 0.85rem; color: #64748b; margin-bottom: 15px; display: flex; gap: 10px; }
.ec-tag { background: #eff6ff; color: #3b82f6; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }

/* Score Box (User) */
.ec-score-box {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    padding: 12px;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
}

/* Timings Grid */
.ec-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    background: #f8fafc;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.ec-grid-item { font-size: 0.8rem; color: #475569; display: flex; flex-direction: column; }
.ec-grid-item span { font-size: 0.7rem; color: #94a3b8; font-weight: 600; text-transform: uppercase; }
.ec-grid-item b { font-weight: 600; }

/* Footer Actions */
.ec-footer {
    padding: 10px 15px;
    background: white;
    border-top: 1px solid #f1f5f9;
    display: flex;
    gap: 8px;
}
.btn-soft { background: #f1f5f9; color: #475569; border: none; font-weight: 600; }
.btn-soft:hover { background: #e2e8f0; }

/* Leaderboard Modal Styles */
.lb-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #f1f5f9;
}
.lb-row:last-child { border-bottom: none; }
.lb-rank { width: 30px; height: 30px; background: #e0e7ff; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
.lb-name { font-weight: 600; font-size: 0.9rem; color: #334155; }
.lb-score { font-weight: 700; color: #16a34a; }

        /* Admin translation input */
        .admin-translation-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }

        .admin-translation-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 6px;
            display: block;
        }

        /* Post Action Buttons */
        .post-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .post-action-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .post-action-btn.edit {
            color: #3b82f6;
            border-color: #93c5fd;
        }

        .post-action-btn.edit:hover {
            background: #dbeafe;
        }

        .post-action-btn.delete {
            color: #ef4444;
            border-color: #fca5a5;
        }

        .post-action-btn.delete:hover {
            background: #fee2e2;
        }

        /* Edit Post Modal */
        .edit-post-modal {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="auth-box">
            <div class="text-center mb-6">
                <i class="fas fa-meteor text-primary" style="font-size: 3rem;"></i>
                <h2 class="mt-2 text-primary">‡¶ß‡ßÇ‡¶Æ‡¶ï‡ßá‡¶§‡ßÅ</h2>
                <p class="text-light text-sm">Ultimate Education Platform</p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <div class="input-group">
                    <input type="tel" id="loginMobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞" value="01700000000">
                </div>
                <div class="input-group">
                    <input type="password" id="loginPass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" value="1234">
                    <i class="fas fa-eye pass-toggle" onclick="togglePass('loginPass', this)"></i>
                </div>
                <div class="flex gap-2 mb-4">
                    <input type="checkbox" id="rememberMe" style="width: auto;">
                    <label for="rememberMe" class="text-sm">‡¶Ü‡¶Æ‡¶æ‡¶ï‡ßá ‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®</label>
                </div>
                <button class="btn mb-4" onclick="handleLogin()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <div class="flex flex-between text-sm">
                    <span class="text-primary font-bold cursor-pointer" onclick="toggleAuth('reg')">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</span>
                    <span class="text-light cursor-pointer" onclick="toggleAuth('admin')">‚≠ï</span>
                </div>
            </div>
            
            <!-- Admin Login Form -->
            <div id="adminForm" class="hidden">
                <h4 class="mb-4 text-center text-danger">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h4>
                <input type="text" id="adminUser" placeholder="‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø" value="admin">
                <div class="input-group">
                    <input type="password" id="adminPassInput" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°" value="1234">
                    <i class="fas fa-eye pass-toggle" onclick="togglePass('adminPassInput', this)"></i>
                </div>
                <button class="btn btn-danger mb-4" onclick="handleAdminLogin()">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</button>
                <div class="text-center text-sm text-primary cursor-pointer" onclick="toggleAuth('login')">‚ùå</div>
            </div>
            
            <!-- Registration Form -->
            <div id="regForm" class="hidden">
                <h4 class="mb-4 text-center text-success">‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶®</h4>
                <input type="text" id="regName" placeholder="‡¶®‡¶æ‡¶Æ">
                <select id="regClass">
                    <option value="Class 6">Class 6</option>
                    <option value="Class 7">Class 7</option>
                    <option value="Class 8">Class 8</option>
                    <option value="Class 9">Class 9</option>
                    <option value="Class 10" selected>Class 10</option>
                    <option value="SSC">SSC</option>
                    <option value="HSC">HSC</option>
                </select>
                <input type="tel" id="regMob" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                <input type="password" id="regPass" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°">
                <button class="btn btn-success" onclick="handleRegister()">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <div class="text-center mt-2 text-sm cursor-pointer" onclick="toggleAuth('login')">üîô</div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <nav class="navbar">
            <div class="nav-brand"><i class="fas fa-book-reader"></i> <span id="headerTitle">‡¶π‡ßã‡¶Æ</span></div>
            <div class="flex gap-3 items-center">
                <div class="text-right">
                    <div class="text-xs text-light" id="navName">User</div>
                    <div class="text-sm font-bold text-success" id="navBal">‡ß≥0</div>
                </div>
                <img src="" id="navAvatar" style="width:35px; height:35px; border-radius:50%; object-fit:cover;" onerror="this.src='https://via.placeholder.com/35'">
                <i class="fas fa-power-off logout-btn-nav" onclick="logoutConfirm()" title="Logout"></i>
            </div>
        </nav>

        <div class="marquee-container">
            <div class="marquee-content" id="marqueeText">Loading Notice...</div>
        </div>

        <div class="p-4">
            <div id="view-home" class="view">
                <a href="https://rds5545.blogspot.com/?m=1" target="_blank" class="card flex flex-between" style="text-decoration: none; border-left: 4px solid #f59e0b;">
                    <div class="flex gap-3">
                        <i class="fas fa-comet fa-2x text-warning"></i>
                        <div><b class="text-primary">‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶∞ ‡¶ß‡ßÇ‡¶Æ‡¶ï‡ßá‡¶§‡ßÅ</b><div class="text-xs text-light">‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡ßü‡¶æ‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ó</div></div>
                    </div>
                    <i class="fas fa-chevron-right text-light"></i>
                </a>

                <div class="card bg-indigo-50 border-indigo-100 flex flex-between">
                    <div><h4 class="text-primary">RDS Library</h4><p class="text-xs text-light">Main External Library</p></div>
                    <a href="https://mahamuds5545-afk.github.io/RDS_Libary/" target="_blank" class="btn btn-sm btn-outline">Visit <i class="fas fa-external-link-alt"></i></a>
                    
                </div>
                
                <h4 class="mb-2 text-light"><i class="fas fa-rss"></i> ‡¶®‡¶ø‡¶â‡¶ú‡¶´‡¶ø‡¶°</h4>
                <div id="postFilterContainer" class="flex gap-2 overflow-x-auto pb-2 mb-2" style="scrollbar-width: none;">
    <button class="filter-btn active" onclick="filterPosts('All', this)">‡¶∏‡¶¨</button>
    </div>
<div id="modal-leaderboard" class="modal hidden">
    <div class="modal-content">
        <div class="flex flex-between mb-4">
            <h3><i class="fas fa-trophy text-warning"></i> ‡¶Æ‡ßá‡¶∞‡¶ø‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <i class="fas fa-times" onclick="document.getElementById('modal-leaderboard').classList.add('hidden')"></i>
        </div>
        <div class="card bg-indigo-50 text-center p-2 mb-2 text-xs">
            ‡¶è‡¶á ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞
        </div>
        <div id="leaderboardBody" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
</div>

<div id="modal-result-view" class="modal hidden">
    <div class="modal-content">
        <div class="flex flex-between mb-4">
            <h3>‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞</h3>
            <i class="fas fa-times" onclick="document.getElementById('modal-result-view').classList.add('hidden')"></i>
        </div>
        <div id="resultDetailsBody" style="padding-bottom: 20px;"></div>
    </div>
</div>

                <div id="postsContainer"></div>
            </div>

            <div id="view-exam" class="view hidden">
                <h4 class="mb-4 text-light">‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ</h4>
                <div id="examList"></div>
            </div>

            <div id="view-library" class="view hidden">
                <div class="card flex flex-between">
                    <div class="flex gap-2"><i class="fas fa-globe fa-2x text-primary"></i><div><b>RDS Main Library</b><div class="text-xs text-light">Official Site</div></div></div>
                    <a href="https://mahamuds5545-afk.github.io/RDS_Libary/" target="_blank" class="btn btn-sm">Open</a>
                </div>
                <h4 class="mb-2 text-light">‡¶™‡¶ø‡¶°‡¶ø‡¶è‡¶´ ‡¶ì ‡¶®‡ßã‡¶ü‡¶∏</h4>
                <div id="libList"></div>
            </div>

            <div id="view-wallet" class="view hidden">
                <div class="card text-center py-6" style="background: linear-gradient(135deg, #4338ca, #6366f1); color: white;">
                    <p class="text-sm">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                    <h1 class="my-2" style="font-size: 2.5rem;" id="walletBigBal">‡ß≥0</h1>
                    <div class="flex gap-2 justify-center mt-4">
                        <button class="btn bg-white text-primary w-auto px-6" onclick="showModal('deposit')"><i class="fas fa-plus"></i> ‡¶ú‡¶Æ‡¶æ</button>
                        <button class="btn bg-white/20 text-white w-auto px-6" onclick="showModal('withdraw')"><i class="fas fa-arrow-down"></i> ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</button>
                    </div>
                </div>
                <h4 class="mb-2 text-light">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h4>
                <div id="txHistory"></div>
            </div>

            <div id="view-profile" class="view hidden">
                <div class="card text-center">
                    <img id="profileAvatar" src="" class="profile-pic" onerror="this.src='https://via.placeholder.com/100'">
                    <h3 id="profileName">User</h3>
                    <p class="text-light text-sm mb-4" id="profileMobile">017XXXXXXXX</p>
                    <button class="btn btn-sm btn-outline w-full mb-2" onclick="document.getElementById('editSection').classList.toggle('hidden')"><i class="fas fa-edit"></i> ‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>

                    <div id="editSection" class="hidden text-left mt-2 bg-gray-50 p-2 rounded">
                        <label class="text-xs font-bold text-light">‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</label>
                        <input type="text" id="editName">
                        <label class="text-xs font-bold text-light">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</label>
                        <input type="text" id="editPass">
                        <label class="text-xs font-bold text-light">‡¶™‡¶ø‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°</label>
                        <input type="file" id="editPicFile" accept="image/*">
                        <button class="btn btn-sm" id="btnUpdateProfile" onclick="updateProfile()">Save Changes</button>
                    </div>
                </div>

                <div class="card">
                    <h4 class="mb-2 text-primary"><i class="fas fa-envelope"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</h4>
                    <div class="flex gap-2">
                        <input type="text" id="userMsgInput" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="margin-bottom:0;">
                        <button class="btn btn-sm w-auto" onclick="sendMsgToAdmin()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <div id="userMsgList" class="mt-4"></div>
                </div>
            </div>

            <div id="view-admin" class="view hidden">
                <div class="card bg-gray-100 flex flex-between">
                    <span>External Admin Panel</span>
                    <a href="https://mahamuds5545-afk.github.io/RDS_Libary/admin" target="_blank" class="btn btn-sm btn-outline">Go <i class="fas fa-external-link-alt"></i></a>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button class="btn btn-sm" onclick="admTab('users')">‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßÄ</button>
                    <button class="btn btn-sm" onclick="admTab('pay')">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</button>
                    <button class="btn btn-sm" onclick="admTab('msg')">‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</button>
                    <button class="btn btn-sm" onclick="admTab('exam')">‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ</button>
                    <button class="btn btn-sm" onclick="admTab('post')">‡¶™‡ßã‡¶∏‡ßç‡¶ü</button>
                    <button class="btn btn-sm" onclick="admTab('lib')">‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø</button>
                    <button class="btn btn-sm" onclick="admTab('set')">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</button>
                </div>

                <div id="adm-users" class="adm-sec">
                    <div class="flex flex-between mb-4">
                        <h4 class="text-light">‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶ì ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</h4>
                        <input type="text" id="searchStudent" placeholder="‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." class="w-auto" style="width: 150px;" onkeyup="searchStudents(this.value)">
                    </div>
                    <div id="admUserList"></div>
                </div>

                <div id="adm-pay" class="adm-sec hidden">
                    <h4 class="mb-2 text-primary">Pending Requests</h4>
                    <div id="admPayList"></div>
                    <h4 class="mb-2 mt-4 text-light">Payment History</h4>
                    <div id="admPayHistory"></div>
                </div>

                <div id="adm-msg" class="adm-sec hidden">
                    <h4 class="mb-2 text-light">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</h4>
                    <div id="admMsgList"></div>
                </div>

                <div id="adm-exam" class="adm-sec hidden">
                    <div class="card">
                        <h4 id="examModalTitle">Create Exam</h4>
                        <input type="hidden" id="exIdx" value="-1">
                        <input type="hidden" id="editExamId" value="">
                        <label class="text-xs">Exam Mode</label>
                        <select id="exMode" onchange="toggleMode()">
                            <option value="Native">Native MCQ</option>
                            <option value="Google">Google Form</option>
                        </select>
                        
                        <input type="text" id="exTitle" placeholder="Exam Title">
                        <select id="exClass">
                            <option value="All">All Classes</option>
                            <option value="Class 6">Class 6</option>
                            <option value="Class 7">Class 7</option>
                            <option value="Class 8">Class 8</option>
                            <option value="Class 9">Class 9</option>
                            <option value="Class 10">Class 10</option>
                            <option value="SSC">SSC</option>
                            <option value="HSC">HSC</option>
                        </select>
                        <div class="flex gap-2">
                            <input type="datetime-local" id="exStart">
                            <input type="datetime-local" id="exEnd">
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="exDur" placeholder="Duration (Min)">
                            <input type="number" id="exFee" placeholder="Entry Fee">
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="exPrize" placeholder="Total Prize" value="0">
                            <input type="number" id="exGift" placeholder="Gift Amount" value="0">
                        </div>
                        
                        <div id="googleMode" class="hidden">
                            <input type="text" id="exLink" placeholder="Google Form Link">
                        </div>

                   <div id="nativeMode">
    <hr class="my-4">
    <div class="flex flex-between mb-2">
        <label class="font-bold">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</label>
        <button class="btn btn-sm w-auto" onclick="addQ()"><i class="fas fa-plus"></i> ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</button>
    </div>
    
    <div id="qList" class="flex-col gap-2">
        </div>
</div>

                        <button class="btn btn-success" id="btnSave" onclick="saveExam()">Save Exam</button>
                        <button class="btn btn-danger hidden" id="btnCancelEdit" onclick="cancelEditExam()">Cancel Edit</button>
                    </div>
                    <h4 class="mb-2 mt-4 text-light">Existing Exams</h4>
                    <div id="admExList"></div>
                </div>

                <div id="adm-post" class="adm-sec hidden">
                    <div class="card">
                        <h4>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü</h4>
                        <label class="text-xs">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</label>
<select id="admPostCategory" class="mb-2">
    <option value="General">General</option>
    </select>

                        <input type="text" id="admPostTitle" placeholder="‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤">
                        <textarea id="admPostContent" rows="3" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§..."></textarea>
                        <textarea id="admPostTranslation" rows="2" placeholder="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"></textarea>
                        <label class="text-xs">‡¶õ‡¶¨‡¶ø</label>
                        <input type="file" id="admPostImg" accept="image/*">
                        <input type="text" id="admPostLink" placeholder="Link">
                        <input type="text" id="admPostLinkTxt" placeholder="Button Text">
                        <button class="btn" id="btnPost" onclick="admAddPost()">‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>

                    <h4 class="mb-2 mt-6 text-light">‡¶∏‡¶ï‡¶≤ ‡¶™‡ßã‡¶∏‡ßç‡¶ü</h4>
                    <div id="allPostsList"></div>
                </div>
                
                <div id="adm-lib" class="adm-sec hidden">
                    <div class="card">
                        <h4>‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø</h4>
                        <input type="text" id="libTitle" placeholder="‡¶®‡¶æ‡¶Æ">
                        <input type="text" id="libLink" placeholder="Link">
                        <select id="libType">
                            <option>PDF</option>
                            <option>Video</option>
                        </select>
                        <button class="btn" onclick="admAddLib()">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </div>
                </div>
                
                <div id="adm-set" class="adm-sec hidden">
                    <div class="card">
                        <h4>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h4>
                        <label class="text-xs">‡¶®‡ßã‡¶ü‡¶ø‡¶∂</label>
                        <input type="text" id="setNotice">
                        <div class="flex gap-2">
                            <div>
                                <label class="text-xs">bKash</label>
                                <input type="text" id="setBkash">
                            </div>
                            <div>
                                <label class="text-xs">Nagad</label>
                                <input type="text" id="setNagad">
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <div>
                                <label class="text-xs">Min Dep</label>
                                <input type="number" id="setMinDep">
                            </div>
                            <div>
                                <label class="text-xs">Min Wd</label>
                                <input type="number" id="setMinWd">
                            </div>
                        </div>
                        <button class="btn" onclick="admSaveSet()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        <hr class="my-4" style="border-top: 1px solid #eee;">
<h4>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h4>
<div class="flex gap-2">
    <input type="text" id="newCatName" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: Notice)">
    <button class="btn w-auto" onclick="admAddCategory()"><i class="fas fa-plus"></i></button>
</div>
<div id="admCatList" class="flex gap-2 flex-wrap mt-2"></div>

                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="nav('home', this)"><i class="fas fa-home"></i> ‡¶π‡ßã‡¶Æ</button>
            <button class="nav-item" onclick="nav('exam', this)"><i class="fas fa-clipboard-check"></i> ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ</button>
            <button class="nav-item" onclick="nav('library', this)"><i class="fas fa-book"></i> ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø</button>
            <button class="nav-item" onclick="nav('wallet', this)"><i class="fas fa-wallet"></i> ‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü</button>
            <button class="nav-item" onclick="nav('profile', this)"><i class="fas fa-user-circle"></i> ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</button>
            <button class="nav-item hidden" id="navAdminBtn" onclick="nav('admin', this)"><i class="fas fa-shield-alt"></i></button>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-deposit" class="modal hidden">
        <div class="modal-content">
            <div class="flex flex-between mb-4">
                <h3>‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü</h3>
                <i class="fas fa-times" onclick="closeModal()"></i>
            </div>
            <div class="card bg-gray-50 text-sm">
                <div class="flex flex-between mb-2">
                    <span>bKash: <b id="viewBkash">...</b></span>
                    <button class="btn-sm btn-outline" onclick="copy('viewBkash')">Copy</button>
                </div>
                <div class="flex flex-between">
                    <span>Nagad: <b id="viewNagad">...</b></span>
                    <button class="btn-sm btn-outline" onclick="copy('viewNagad')">Copy</button>
                </div>
                <div class="text-center mt-2 text-xs text-light">Min Deposit: ‡ß≥<span id="viewMinDep"></span></div>
            </div>
            <input type="number" id="depAmt" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
            <select id="depMethod">
                <option>bKash</option>
                <option>Nagad</option>
            </select>
            <input type="text" id="depTrx" placeholder="TrxID">
            <button class="btn btn-success" onclick="reqDep()">Send Request</button>
        </div>
    </div>

    <div id="modal-withdraw" class="modal hidden">
        <div class="modal-content">
            <div class="flex flex-between mb-4">
                <h3>‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</h3>
                <i class="fas fa-times" onclick="closeModal()"></i>
            </div>
            <p class="text-center text-sm mb-4">Min Withdraw: ‡ß≥<span id="viewMinWd"></span></p>
            <input type="number" id="wdAmt" placeholder="Amount">
            <select id="wdMethod">
                <option>bKash</option>
                <option>Nagad</option>
            </select>
            <input type="text" id="wdNum" placeholder="Phone Number">
            <button class="btn btn-danger" onclick="reqWd()">Withdraw</button>
        </div>
    </div>

    <div id="modal-edit-user" class="modal hidden">
        <div class="modal-content">
            <div class="flex flex-between mb-4">
                <h3>Edit Student</h3>
                <i class="fas fa-times" onclick="closeModal()"></i>
            </div>
            <input type="hidden" id="editUserMobile">
            
            <div class="text-center mb-4">
                <img id="editUserAvatar" src="" class="profile-pic-small" style="display: inline-block;" onerror="this.src='https://via.placeholder.com/50'">
            </div>
            
            <input type="text" id="editUserName" placeholder="Name">
            <select id="editUserClass">
                <option value="Class 6">Class 6</option>
                <option value="Class 7">Class 7</option>
                <option value="Class 8">Class 8</option>
                <option value="Class 9">Class 9</option>
                <option value="Class 10">Class 10</option>
                <option value="SSC">SSC</option>
                <option value="HSC">HSC</option>
            </select>
            
            <div class="flex gap-2 mb-4">
                <input type="number" id="editUserBal" placeholder="Balance">
                <input type="password" id="editUserPass" placeholder="Password">
            </div>
            
            <label class="text-xs font-bold text-light">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶ø‡¶ï‡¶ö‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</label>
            <input type="file" id="editUserPicFile" accept="image/*">
            
            <div class="flex gap-2 mt-4">
                <button class="btn btn-success" onclick="saveUserChanges()">Save Changes</button>
                <button class="btn btn-danger" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-exam" class="modal hidden">
        <div class="modal-content" style="border-radius: 0; max-width: 100%; height: 100%; padding: 0;">
            <div class="timer-bar">
                <span id="runExamTitle">Exam</span>
                <span id="timerDisplay">00:00</span>
            </div>
            <div id="examBody" class="p-4" style="padding-bottom: 80px;"></div>
            <div style="position: fixed; bottom: 0; left: 0; width: 100%; padding: 12px; background: white; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                <button class="btn btn-danger w-1/3" onclick="closeModal()">Exit</button>
                <button class="btn btn-success w-2/3" onclick="submitExam()">Submit</button>
            </div>
        </div>
    </div>

    <!-- New Modal for Exam Attendees -->
    <div id="modal-attendees" class="modal hidden">
        <div class="modal-content">
            <div class="flex flex-between mb-4">
                <h3 id="attendeeTitle">Exam Attendees</h3>
                <i class="fas fa-times" onclick="closeModal()"></i>
            </div>
            <div id="attendeeListContent"></div>
        </div>
    </div>

    <!-- Edit Post Modal -->
    <div id="modal-edit-post" class="modal hidden">
        <div class="modal-content edit-post-modal">
            <div class="flex flex-between mb-4">
                <h3>‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
                <i class="fas fa-times" onclick="closeModal()"></i>
            </div>
            <input type="hidden" id="editPostId">
            <label class="text-xs">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
<select id="editPostCategoryInput" class="mb-2">
    </select>

            <input type="text" id="editPostTitle" placeholder="‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤">
            <textarea id="editPostContent" rows="4" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§..."></textarea>
            <textarea id="editPostTranslation" rows="2" placeholder="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"></textarea>
            
            <div class="mb-4">
                <label class="text-xs font-bold text-light">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶õ‡¶¨‡¶ø</label>
                <img id="currentPostImage" src="" style="max-width: 100%; border-radius: 8px; margin-top: 5px; max-height: 200px; object-fit: cover;" onerror="this.style.display='none'">
            </div>
            
            <label class="text-xs font-bold text-light">‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
            <input type="file" id="editPostImg" accept="image/*">
            
            <input type="text" id="editPostLink" placeholder="‡¶≤‡¶ø‡¶Ç‡¶ï">
            <input type="text" id="editPostLinkTxt" placeholder="‡¶¨‡¶æ‡¶ü‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü">
            
            <div class="flex gap-2 mt-6">
                <button class="btn btn-success" onclick="updatePost()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-danger" onclick="closeModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBC9hwiWQS0rPMyvj3XVPdpExB1RSyQi1E",
            authDomain: "myblogapp-8e9e5cc8.firebaseapp.com",
            databaseURL: "https://myblogapp-8e9e5cc8-default-rtdb.firebaseio.com/",
            projectId: "myblogapp-8e9e5cc8",
            storageBucket: "myblogapp-8e9e5cc8.firebasestorage.app",
            messagingSenderId: "995232144893",
            appId: "1:995232144893:web:9ca49253831a0e06404d94"
        };

        // ==================== FIREBASE INITIALIZATION ====================
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("üî• Firebase initialized successfully");
            }
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
        }

        const db = firebase.database();
        const IMGBB_KEY = 'a6b5ca76210be29fd294f56e3681660f';
        
        let CURR_USER = null;
        let DB_DATA = null;
        let ACTIVE_EXAM = null;
        let TIMER_INT = null;
        let EDITING_EXAM_ID = null;
        
        // ==================== DATABASE INITIALIZATION ====================
    async function initializeDatabase() {
    try {
        console.log("üì° Checking database...");
        
        const snapshot = await db.ref().once('value');
        const data = snapshot.val();
        
        if (!data || !data.users || !data.config) {
            console.log("üì¶ Initializing database with default data...");
            await setupDefaultDatabase();
        } else {
            console.log("‚úÖ Database already initialized");
            DB_DATA = data;
        }
        
        return true;
    } catch (error) {
        console.error("‚ùå Database initialization error:", error);
        return false;
    }
}
// ‡ß©. ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶ì ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (FIXED)
async function viewExamResult(eid) {
    console.log("Fetching result for:", eid); // ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

    // ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡¶æ (‡¶¨‡ßã‡¶ù‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡ßá ‡¶ï‡¶æ‡¶ú ‡¶π‡¶ö‡ßç‡¶õ‡ßá)
    const btn = document.activeElement; // ‡¶Ø‡ßá ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
    const originalText = btn ? btn.innerText : '';
    if(btn) btn.innerText = "‡¶≤‡ßã‡¶°‡¶ø‡¶Ç...";

    try {
        const examSnap = await db.ref('exams/' + eid).once('value');
        const exam = examSnap.val();
        
        // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ
        const resSnap = await db.ref('results').once('value');
        const results = resSnap.val();
        
        if (!exam) throw new Error("Exam data not found!");
        if (!results) throw new Error("No results found in database!");

        // ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞
        // ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶¨ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶≤‡ßÅ‡¶™ ‡¶ï‡¶∞‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶≠‡ßÅ‡¶≤ ‡¶®‡¶æ ‡¶π‡ßü
        const myRes = Object.values(results).find(r => r.eid === eid && r.uid === CURR_USER.id);
        
        if (!myRes) {
            throw new Error("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡¶≤‡ßá‡¶®?");
        }

        const container = document.getElementById('resultDetailsBody');
        container.innerHTML = '';

        // ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° (‡¶â‡¶™‡¶∞‡ßá)
        container.innerHTML += `
            <div class="card bg-indigo-50 text-center mb-4">
                <h4 class="text-primary">‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h4>
                <h1 style="font-size: 2.5rem; margin: 10px 0;">${myRes.score} / ${myRes.total}</h1>
                <p class="text-xs text-light">‡¶Ö‡¶∞‡ßç‡¶ú‡¶ø‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: ${myRes.percentage}%</p>
            </div>
        `;

        // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶¨‡¶Ç ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡ßÅ‡¶™
        if (exam.questions) {
            exam.questions.forEach((q, i) => {
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßÄ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡¶ø‡¶≤?
                const userAns = (myRes.userAnswers && myRes.userAnswers[i] !== undefined) ? parseInt(myRes.userAnswers[i]) : -1;
                const correctAns = parseInt(q.ans);
                
                // ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï
                let statusBadge = '';
                if (userAns === correctAns) {
                    statusBadge = '<span class="text-success font-bold"><i class="fas fa-check"></i> ‡¶∏‡¶†‡¶ø‡¶ï</span>';
                } else if (userAns === -1) {
                    statusBadge = '<span class="text-warning font-bold"><i class="fas fa-minus"></i> ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶®‡¶®‡¶ø</span>';
                } else {
                    statusBadge = '<span class="text-danger font-bold"><i class="fas fa-times"></i> ‡¶≠‡ßÅ‡¶≤</span>';
                }

                // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®
                let qContent = q.type === 'image' 
                    ? `<img src="${q.val}" class="q-img" style="max-height:150px; width:auto;">` 
                    : `<div class="mb-2 font-bold">${q.val}</div>`;

                // ‡¶Ö‡¶™‡¶∂‡¶®
                let optsHtml = '';
                if (q.opts) {
                    q.opts.forEach((opt, idx) => {
                        let style = 'padding:10px; border:1px solid #eee; margin-bottom:5px; border-radius:6px; font-size:0.9rem;';
                        let icon = '';

                        // ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
                        if (idx === correctAns) {
                            // ‡¶∏‡¶†‡¶ø‡¶ï ‡¶â‡¶§‡ßç‡¶§‡¶∞ (‡¶∏‡¶¨‡ßÅ‡¶ú)
                            style = 'padding:10px; border:1px solid #86efac; background:#dcfce7; color:#14532d; font-weight:bold;';
                            icon = '<i class="fas fa-check-circle float-right"></i>';
                        } 
                        else if (idx === userAns && idx !== correctAns) {
                            // ‡¶≠‡ßÅ‡¶≤ ‡¶â‡¶§‡ßç‡¶§‡¶∞ (‡¶≤‡¶æ‡¶≤)
                            style = 'padding:10px; border:1px solid #fca5a5; background:#fee2e2; color:#7f1d1d; text-decoration:line-through;';
                            icon = '<i class="fas fa-times-circle float-right"></i>';
                        }

                        optsHtml += `
                            <div style="${style}">
                                <span>${opt}</span>
                                ${icon}
                            </div>
                        `;
                    });
                }

                container.innerHTML += `
                    <div class="card" style="margin-bottom:15px; border:1px solid #f1f5f9;">
                        <div class="flex flex-between mb-2 pb-2" style="border-bottom:1px dashed #e2e8f0;">
                            <span class="text-xs text-light">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i+1}</span>
                            ${statusBadge}
                        </div>
                        ${qContent}
                        <div class="mt-2">${optsHtml}</div>
                    </div>
                `;
            });
        }

        // MathJax ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        if(window.MathJax) {
            setTimeout(() => MathJax.typesetPromise(), 100);
        }

        // ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
        document.getElementById('modal-result-view').classList.remove('hidden');

    } catch (error) {
        console.error("View Result Error:", error);
        alert("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
    } finally {
        // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶Ü‡¶®‡¶æ
        if(btn) btn.innerHTML = originalText;
    }
}
// ==================== USER MESSAGE FUNCTIONS ====================

async function saveUserChanges() {
    // ‡ßß. ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶®‡ßá‡¶ì‡ßü‡¶æ
    const mobile = document.getElementById('editUserMobile').value; // ‡¶π‡¶ø‡¶°‡ßá‡¶® ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞
    const name = document.getElementById('editUserName').value.trim();
    const cls = document.getElementById('editUserClass').value;
    const bal = parseInt(document.getElementById('editUserBal').value) || 0;
    const pass = document.getElementById('editUserPass').value.trim();
    const fileInput = document.getElementById('editUserPicFile');

    if (!mobile) return alert("Error: User ID missing!");

    // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤
    const btn = document.querySelector('#modal-edit-user .btn-success');
    const oldText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        let updates = {
            name: name,
            class: cls,
            bal: bal,
            pass: pass
        };

        // ‡ß®. ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü
        if (fileInput.files.length > 0) {
            btn.innerText = "Uploading Image...";
            const imgUrl = await uploadImg(fileInput.files[0]);
            if (imgUrl) {
                updates.avatar = imgUrl;
            } else {
                throw new Error("Image upload failed");
            }
        }

        // ‡ß©. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        await db.ref('users/' + mobile).update(updates);
        
        // ‡ß™. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶õ‡¶æ‡ßú‡¶æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
        if (DB_DATA.users && DB_DATA.users[mobile]) {
            DB_DATA.users[mobile] = { ...DB_DATA.users[mobile], ...updates };
        }

        alert("‚úÖ ‡¶∏‡ßç‡¶ü‡ßÅ‡¶°‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        closeModal();
        
        // ‡ß´. ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        renderAdminUsers();

    } catch (error) {
        console.error("Edit Error:", error);
        alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡¶®‡¶ø: " + error.message);
    } finally {
        btn.innerText = oldText;
        btn.disabled = false;
    }
}

    // ‡ßß. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
async function sendMsgToAdmin() {
    const input = document.getElementById('userMsgInput');
    const text = input.value.trim();
    
    if (!text) return alert("‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!");

    const btn = document.querySelector('#view-profile .btn-sm');
    const oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        const msgData = {
            uid: CURR_USER.id,
            name: CURR_USER.name,
            text: text,
            reply: "", // ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶®‡ßá‡¶á
            time: Date.now()
        };

        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
        const ref = await db.ref('msgs').push(msgData);
        
        // --- ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶•‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡ßü) ---
        if (!DB_DATA.msgs) DB_DATA.msgs = {};
        DB_DATA.msgs[ref.key] = msgData;

        input.value = ''; // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
        renderMessages(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂

    } catch (error) {
        console.error("Msg Error:", error);
        alert("‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
    } finally {
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
}

// ‡ß®. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã (User View)
function renderMessages() {
    const container = document.getElementById('userMsgList');
    if (!container) return;
    
    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá
    if (!DB_DATA || !DB_DATA.msgs) {
        container.innerHTML = '<p class="text-xs text-light text-center">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶®‡ßá‡¶á</p>';
        return;
    }

    container.innerHTML = '';
    
    // ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
    const myMsgs = Object.entries(DB_DATA.msgs)
        .filter(([, m]) => m.uid === CURR_USER.id)
        .sort(([, a], [, b]) => b.time - a.time);

    myMsgs.forEach(([id, m]) => {
        // ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü
        const timeStr = new Date(m.time).toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

        container.innerHTML += `
            <div class="msg-box" style="margin-bottom:10px; background:#fff; border:1px solid #eee;">
                <div class="flex flex-between">
                    <span class="text-xs font-bold text-primary">You</span>
                    <span class="text-xs text-light">${timeStr}</span>
                </div>
                <div class="text-sm mt-1">${m.text}</div>
                
                ${m.reply ? `
                    <div class="admin-reply mt-2" style="background:#f0fdf4; padding:8px; border-radius:6px; border-left:3px solid #16a34a;">
                        <span class="text-xs font-bold text-success">Admin Reply:</span>
                        <div class="text-sm">${m.reply}</div>
                    </div>
                ` : `<div class="text-xs text-warning mt-1"><i class="far fa-clock"></i> ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç...</div>`}
            </div>
        `;
    });
}

  async function setupDefaultDatabase() {
    const defaultData = {
        config: {
            notice: "üéâ Welcome to MRDS Education Platform v6.2!",
            bkash: "01700000000",
            nagad: "01800000000",
            minDep: 50,
            minWd: 100,
            lastUpdated: Date.now()
        },
        // --- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ---
        categories: {
            'cat1': 'General',
            'cat2': 'Exam',
            'cat3': 'Result',
            'cat4': 'Notice'
        },
        // ----------------------------------
        users: {
            'admin': {
                name: 'System Administrator',
                pass: '1234',
                role: 'admin',
                bal: 0,
                avatar: '',
                class: 'Admin',
                created: Date.now(),
                lastLogin: null
            },
            '01700000000': {
                name: '‡¶°‡ßá‡¶Æ‡ßã ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ',
                pass: '1234',
                role: 'student',
                bal: 100,
                avatar: '',
                class: 'Class 10',
                created: Date.now(),
                lastLogin: null
            }
        },
        posts: {
            'post1': {
                t: '‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ MRDS ‡¶è!',
                c: '‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶°‡ßá‡¶Æ‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§',
                img: '',
                link: '',
                linkTxt: '',
                category: 'General', // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø
                timestamp: Date.now()
            }
        },
        exams: {
            'exam1': {
                title: 'Class 10 ‡¶ó‡¶£‡¶ø‡¶§ ‡¶ü‡ßá‡¶∏‡ßç‡¶ü',
                mode: 'Native',
                class: 'Class 10',
                start: new Date(Date.now() + 86400000).toISOString().slice(0, 16),
                end: new Date(Date.now() + 172800000).toISOString().slice(0, 16),
                dur: 30,
                fee: 10,
                prize: 100,
                giftAmount: 20,
                questions: [
                    {
                        type: 'text',
                        val: '‡ß® + ‡ß® = ‡¶ï‡¶§?',
                        opts: ['‡ß©', '‡ß™', '‡ß´', '‡ß¨'],
                        ans: 1
                    },
                    {
                        type: 'text',
                        val: '‡ßß‡ß¨-‡¶è‡¶∞ ‡¶¨‡¶∞‡ßç‡¶ó‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶§?',
                        opts: ['‡ß®', '‡ß©', '‡ß™', '‡ß´'],
                        ans: 2
                    }
                ],
                created: Date.now()
            }
        },
        library: {
            'lib1': {
                title: 'Class 10 Mathematics PDF',
                link: 'https://example.com/math.pdf',
                type: 'PDF',
                added: Date.now()
            }
        },
        txs: {},
        results: {},
        msgs: {},
        gifts: {}
    };

    try {
        await db.ref().set(defaultData);
        console.log("‚úÖ Default database setup completed");
        DB_DATA = defaultData;
        return true;
    } catch (error) {
        console.error("‚ùå Database setup failed:", error);
        return false;
    }
}

        function togglePass(id, icon) {
            const input = document.getElementById(id);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function toggleAuth(type) {
            ['loginForm', 'regForm', 'adminForm'].forEach(i => {
                document.getElementById(i).classList.add('hidden');
            });
            document.getElementById(type + 'Form').classList.remove('hidden');
        }

        async function handleAdminLogin() {
            const username = document.getElementById('adminUser').value.trim();
            const password = document.getElementById('adminPassInput').value.trim();
            
            if (!username || !password) {
                alert("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®");
                return;
            }
            
            const btn = document.querySelector('#adminForm button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            btn.disabled = true;
            
            try {
                const userSnapshot = await db.ref('users/' + username).once('value');
                const user = userSnapshot.val();
                
                if (!user) {
                    alert("‚ùå ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø");
                    return;
                }
                
                if (user.role !== 'admin') {
                    alert("‚ùå ‡¶è‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®");
                    return;
                }
                
                if (user.pass !== password) {
                    alert("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°");
                    return;
                }
                
                await db.ref('users/' + username + '/lastLogin').set(Date.now());
                
                CURR_USER = {
                    id: username,
                    ...user
                };
                
                alert("‚úÖ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤!\n\nWelcome " + user.name);
                
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                setupAdminFeatures();
                renderApp();
                
            } catch (error) {
                console.error("‚ùå Admin login error:", error);
                alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
async function editExam(id) {
    const snap = await db.ref('exams/' + id).once('value');
    const exam = snap.val();
    if (!exam) return;

    document.getElementById('editExamId').value = id;
    document.getElementById('examModalTitle').innerText = "Edit Exam";
    document.getElementById('btnCancelEdit').classList.remove('hidden');

    // Fill Basic Info
    document.getElementById('exTitle').value = exam.title;
    document.getElementById('exClass').value = exam.class;
    document.getElementById('exMode').value = exam.mode;
    document.getElementById('exStart').value = exam.start;
    document.getElementById('exEnd').value = exam.end;
    document.getElementById('exDur').value = exam.dur;
    document.getElementById('exFee').value = exam.fee;
    document.getElementById('exPrize').value = exam.prize || 0;
    document.getElementById('exGift').value = exam.giftAmount || 0;

    toggleMode(); // Show/Hide correct section

    if (exam.mode === 'Google') {
        document.getElementById('exLink').value = exam.link || '';
    } else {
        // Load Questions
        const qList = document.getElementById('qList');
        qList.innerHTML = ''; // Clear previous
        if (exam.questions) {
            exam.questions.forEach(q => {
                addQ(q); // Pass existing data to addQ
            });
        }
    }
    
    // Scroll to top of form
    document.getElementById('adm-exam').scrollIntoView();
}

function cancelEditExam() {
    document.getElementById('editExamId').value = '';
    document.getElementById('examModalTitle').innerText = "Create Exam";
    document.getElementById('btnCancelEdit').classList.add('hidden');
    document.getElementById('exTitle').value = '';
    document.getElementById('qList').innerHTML = '';
}

        async function handleLogin() {
            const mobile = document.getElementById('loginMobile').value.trim();
            const password = document.getElementById('loginPass').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            
            if (!mobile || !password) {
                alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®");
                return;
            }
            
            const btn = document.querySelector('#loginForm button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';
            btn.disabled = true;
            
            try {
                const userSnapshot = await db.ref('users/' + mobile).once('value');
                const user = userSnapshot.val();
                
                if (!user) {
                    alert("‚ùå ‡¶è‡¶á ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á");
                    return;
                }
                
                if (user.pass !== password) {
                    alert("‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°");
                    return;
                }
                
                if (remember) {
                    localStorage.setItem('mrds_user', mobile);
                    localStorage.setItem('mrds_pass', password);
                } else {
                    localStorage.removeItem('mrds_user');
                    localStorage.removeItem('mrds_pass');
                }
                
                await db.ref('users/' + mobile + '/lastLogin').set(Date.now());
                
                CURR_USER = {
                    id: mobile,
                    ...user
                };
                
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                if (user.role === 'admin') {
                    setupAdminFeatures();
                }
                
                renderApp();
                
            } catch (error) {
                console.error("‚ùå Login error:", error);
                alert("‡¶≤‡¶ó‡¶á‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleRegister() {
            const name = document.getElementById('regName').value.trim();
            const className = document.getElementById('regClass').value;
            const mobile = document.getElementById('regMob').value.trim();
            const password = document.getElementById('regPass').value.trim();
            
            if (!name || !mobile || !password) {
                alert("‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®");
                return;
            }
            
            if (mobile.length !== 11 || !mobile.startsWith('01')) {
                alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶® (11 ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü, 01 ‡¶¶‡¶ø‡ßü‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ)");
                return;
            }
            
            const userSnapshot = await db.ref('users/' + mobile).once('value');
            if (userSnapshot.exists()) {
                alert("‡¶è‡¶á ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶°");
                toggleAuth('login');
                return;
            }
            
            const newUser = {
                name: name,
                pass: password,
                role: 'student',
                bal: 0,
                avatar: '',
                class: className,
                created: Date.now(),
                lastLogin: null
            };
            
            try {
                await db.ref('users/' + mobile).set(newUser);
                alert("‚úÖ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤!\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤: " + mobile + "\n‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°: " + password);
                
                document.getElementById('loginMobile').value = mobile;
                document.getElementById('loginPass').value = password;
                toggleAuth('login');
                
            } catch (error) {
                alert("‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + error.message);
            }
        }

        function setupAdminFeatures() {
            document.getElementById('navAdminBtn').classList.remove('hidden');
            console.log("üõ†Ô∏è Admin features enabled for:", CURR_USER.name);
        }

        // ==================== RENDER FUNCTIONS ====================
        async function renderApp() {
            if (!CURR_USER) return;
            
            console.log("üé® Rendering app for:", CURR_USER.name);
            
            try {
                const snapshot = await db.ref().once('value');
                DB_DATA = snapshot.val();
                
                updateUserUI();
                renderConfig();
                // renderApp ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá
                renderCategories(); // ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                renderPosts();
                renderExams();
                renderLibrary();
                renderTransactions();
                renderMessages();
                
                if (CURR_USER.role === 'admin') {
                    renderAdminDashboard();
                }
                
            } catch (error) {
                console.error("‚ùå Render error:", error);
            }
        }
// ==================== CATEGORY & FILTER FUNCTIONS ====================

// 1. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (Admin & User)
function renderCategories() {
    // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡¶¶‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
    const categories = (DB_DATA && DB_DATA.categories) ? DB_DATA.categories : {'def': 'General'};
    
    // A. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    const filterContainer = document.getElementById('postFilterContainer');
    if(filterContainer) {
        let html = `<button class="filter-btn active" onclick="filterPosts('All', this)">‡¶∏‡¶¨</button>`;
        Object.values(categories).forEach(cat => {
            html += `<button class="filter-btn" onclick="filterPosts('${cat}', this)">${cat}</button>`;
        });
        filterContainer.innerHTML = html;
    }

    // B. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶è‡¶°‡¶ø‡¶ü ‡¶™‡ßã‡¶∏‡ßç‡¶ü)
    const admSelect = document.getElementById('admPostCategory');
    const editSelect = document.getElementById('editPostCategoryInput');
    
    let options = '';
    Object.values(categories).forEach(cat => {
        options += `<option value="${cat}">${cat}</option>`;
    });

    if(admSelect) admSelect.innerHTML = options;
    if(editSelect) editSelect.innerHTML = options;

    // C. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    const admList = document.getElementById('admCatList');
    if(admList) {
        admList.innerHTML = '';
        Object.entries(categories).forEach(([key, cat]) => {
            admList.innerHTML += `
                <span class="bg-gray-200 px-2 py-1 rounded text-xs flex items-center gap-1">
                    ${cat} <i class="fas fa-times text-danger cursor-pointer" onclick="deleteCategory('${key}')"></i>
                </span>
            `;
        });
    }
}
// ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function updateProfile() {
    const name = document.getElementById('editName').value.trim();
    const pass = document.getElementById('editPass').value.trim();
    const fileInput = document.getElementById('editPicFile');
    
    // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤
    const btn = document.getElementById('btnUpdateProfile');
    const originalText = btn.innerText;
    btn.innerText = "‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...";
    btn.disabled = true;

    try {
        let updates = {};
        let hasChanges = false;
        
        // ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá
        if (name && name !== CURR_USER.name) {
            updates.name = name;
            hasChanges = true;
        }
        
        // ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá
        if (pass && pass !== CURR_USER.pass) {
            updates.pass = pass;
            hasChanges = true;
        }
        
        // ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá
        if (fileInput.files.length > 0) {
            btn.innerText = "‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            const imgUrl = await uploadImg(fileInput.files[0]);
            
            if (imgUrl) {
                updates.avatar = imgUrl;
                hasChanges = true;
            } else {
                // ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá
                throw new Error("‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            }
        }

        if (hasChanges) {
            // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            await db.ref('users/' + CURR_USER.id).update(updates);
            
            // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            CURR_USER = { ...CURR_USER, ...updates };
            
            // ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶≤‡ßç‡¶ü‡¶æ‡¶≤‡ßá ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            if(updates.pass && localStorage.getItem('mrds_pass')) {
                localStorage.setItem('mrds_pass', updates.pass);
            }

            alert("‚úÖ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            
            // ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
            document.getElementById('editName').value = '';
            document.getElementById('editPass').value = '';
            document.getElementById('editPicFile').value = '';
            document.getElementById('editSection').classList.add('hidden');
            
            // UI ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
            updateUserUI();
        } else {
            alert("‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
        }

    } catch (error) {
        console.error("Profile Update Error:", error);
        alert("‡¶è‡¶∞‡¶∞: " + error.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// 2. ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
function filterPosts(category, btnElement) {
    // ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶ï‡¶ü‡¶ø‡¶≠ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');

    // ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
    const allPosts = document.querySelectorAll('.post-item-wrapper');
    allPosts.forEach(post => {
        const postCat = post.getAttribute('data-category');
        if (category === 'All' || postCat === category) {
            post.classList.remove('hidden');
        } else {
            post.classList.add('hidden');
        }
    });
}

// 3. ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶æ (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®)
async function admAddCategory() {
    const name = document.getElementById('newCatName').value.trim();
    if(!name) return alert("‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®");

    try {
        await db.ref('categories').push(name);
        document.getElementById('newCatName').value = '';
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
        
        // ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶°‡¶æ‡¶ü‡¶æ
        const snap = await db.ref().once('value');
        DB_DATA = snap.val();
        renderCategories();
    } catch(e) {
        alert(e.message);
    }
}

// 4. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ
async function deleteCategory(key) {
    if(!confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
    await db.ref('categories/' + key).remove();
    const snap = await db.ref().once('value');
    DB_DATA = snap.val();
    renderCategories();
}

        function updateUserUI() {
            if (!CURR_USER) return;
            
            document.getElementById('navName').innerText = CURR_USER.name;
            document.getElementById('profileName').innerText = CURR_USER.name;
            document.getElementById('navBal').innerText = `‡ß≥${CURR_USER.bal || 0}`;
            document.getElementById('walletBigBal').innerText = `‡ß≥${CURR_USER.bal || 0}`;
            document.getElementById('navAvatar').src = CURR_USER.avatar || 'https://via.placeholder.com/35';
            document.getElementById('profileAvatar').src = CURR_USER.avatar || 'https://via.placeholder.com/100';
            document.getElementById('profileMobile').innerText = CURR_USER.id;
            
            if (DB_DATA && DB_DATA.config) {
                document.getElementById('marqueeText').innerText = DB_DATA.config.notice || 'Welcome to MRDS';
            }
        }

        function renderConfig() {
            if (!DB_DATA || !DB_DATA.config) return;
            
            const config = DB_DATA.config;
            document.getElementById('viewBkash').innerText = config.bkash || 'N/A';
            document.getElementById('viewNagad').innerText = config.nagad || 'N/A';
            document.getElementById('viewMinDep').innerText = config.minDep || 0;
            document.getElementById('viewMinWd').innerText = config.minWd || 0;
        }

        function renderPosts() {
            const container = document.getElementById('postsContainer');
            if (!container) return;

            if (!DB_DATA || !DB_DATA.posts) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">‡¶ï‡ßã‡¶®‡ßã ‡¶®‡¶ø‡¶â‡¶ú ‡¶¨‡¶æ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶®‡ßá‡¶á</p></div>';
                return;
            }

            const posts = DB_DATA.posts;
            container.innerHTML = '';
            
            Object.entries(posts)
                .sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0))
                .forEach(([id, post]) => {
                    // Detect if post is in English (simple detection)
                    const isEnglish = /[a-zA-Z]/.test(post.t || '') || /[a-zA-Z]/.test(post.c || '');
                    
                    let imgHtml = '';
                    if(post.img) {
                        imgHtml = `<img src="${post.img}" class="post-img" style="width:100%; border-radius:8px; margin-top:10px; margin-bottom:10px; border:1px solid #eee;">`;
                    }

                    let linkHtml = '';
                    if(post.link) {
                        linkHtml = `<a href="${post.link}" target="_blank" class="btn btn-sm btn-outline mt-2 w-auto" style="display:inline-block;">
                            ${post.linkTxt || '‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®'} <i class="fas fa-external-link-alt"></i>
                        </a>`;
                    }

                    const dateStr = post.timestamp ? new Date(post.timestamp).toLocaleDateString('bn-BD', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '';

                    const category = post.category || 'General'; 

const html = `
    <div class="card mb-3 post-item-wrapper" data-category="${category}" style="border-left: 4px solid var(--primary);">
        <div class="post-header" onclick="togglePost('${id}')">
            <div class="post-title-wrapper">
                
                <span class="post-cat-badge">${category}</span>

                <div class="flex items-center">
                    <h3 class="text-primary" style="font-size: 1.2rem; font-weight: bold; margin: 0;">
                        ${post.t || post.title || 'Untitled'}
                    </h3>
                                        ${isEnglish && (post.bnTranslation || CURR_USER?.role === 'admin') ? 
                                            `<button class="translate-btn" onclick="showTranslation(event, '${id}')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</button>` : ''}
                                    </div>
                                    <div class="post-date"><i class="far fa-clock"></i> ${dateStr}</div>
                                </div>
                                <i class="fas fa-chevron-down post-expand-icon" id="post-icon-${id}"></i>
                            </div>
                            
                            <div class="post-content" id="post-content-${id}">
                                <p class="text-sm" style="white-space: pre-wrap; color: #4b5563; line-height: 1.6;">${post.c || post.content || ''}</p>
                                
                                ${imgHtml}
                                ${linkHtml}
                                
                                <!-- Translation section (hidden by default) -->
                                ${post.bnTranslation ? 
                                    `<div class="post-translation" id="translation-${id}">
                                        <strong><i class="fas fa-language"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶:</strong><br>
                                        ${post.bnTranslation}
                                    </div>` : ''
                                }
                                
                                <!-- Admin actions -->
                                ${CURR_USER?.role === 'admin' ? `
                                    <div class="admin-translation-box mt-3">
                                        <label class="admin-translation-label">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶Ø‡ßã‡¶ó/‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                                        <textarea id="admin-translation-${id}" placeholder="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="2" style="width:100%; padding:8px; border-radius:4px; border:1px solid var(--border);">${post.bnTranslation || ''}</textarea>
                                        <div class="post-actions">
                                            <button class="post-action-btn edit" onclick="editPost('${id}')">
                                                <i class="fas fa-edit"></i> ‡¶è‡¶°‡¶ø‡¶ü
                                            </button>
                                            <button class="post-action-btn delete" onclick="deletePost('${id}')">
                                                <i class="fas fa-trash"></i> ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü
                                            </button>
                                            <button class="btn btn-sm" onclick="saveTranslation('${id}')">‡¶∏‡ßá‡¶≠ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶</button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    container.innerHTML += html;
                });
        }

        // ==================== POST INTERACTION FUNCTIONS ====================
        function togglePost(postId) {
            const content = document.getElementById('post-content-' + postId);
            const icon = document.getElementById('post-icon-' + postId);
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                
                // Also hide translation when collapsing
                const translation = document.getElementById('translation-' + postId);
                if (translation) {
                    translation.classList.remove('show');
                }
            }
        }

        function showTranslation(event, postId) {
            event.stopPropagation(); // Prevent post toggle
            
            const translationDiv = document.getElementById('translation-' + postId);
            const contentDiv = document.getElementById('post-content-' + postId);
            
            // Make sure post is expanded
            if (!contentDiv.classList.contains('expanded')) {
                contentDiv.classList.add('expanded');
                const icon = document.getElementById('post-icon-' + postId);
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                icon.classList.add('expanded');
            }
            
            // Toggle translation visibility
            if (translationDiv) {
                translationDiv.classList.toggle('show');
            }
            
            // If admin, focus on translation textarea
            if (CURR_USER?.role === 'admin') {
                const adminTextarea = document.getElementById('admin-translation-' + postId);
                if (adminTextarea) {
                    setTimeout(() => {
                        adminTextarea.focus();
                    }, 300);
                }
            }
        }

        // ==================== POST EDIT & DELETE FUNCTIONS ====================
        async function editPost(postId) {
            try {
                const postSnap = await db.ref('posts/' + postId).once('value');
                const post = postSnap.val();
                
                if (!post) {
                    alert('Post not found');
                    return;
                }
                
                // Fill form with post data
                document.getElementById('editPostId').value = postId;
                document.getElementById('editPostTitle').value = post.t || post.title || '';
                document.getElementById('editPostContent').value = post.c || post.content || '';
                document.getElementById('editPostTranslation').value = post.bnTranslation || '';
                document.getElementById('editPostLink').value = post.link || '';
                document.getElementById('editPostLinkTxt').value = post.linkTxt || '';
                
                // Set current image
                const currentImg = document.getElementById('currentPostImage');
                if (post.img) {
                    currentImg.src = post.img;
                    currentImg.style.display = 'block';
                } else {
                    currentImg.style.display = 'none';
                }
                
                // Clear file input
                document.getElementById('editPostImg').value = '';
                
                showModal('edit-post');
                
            } catch (error) {
                console.error('Error loading post for edit:', error);
                alert('Failed to load post: ' + error.message);
            }
        }

        async function updatePost() {
            const postId = document.getElementById('editPostId').value;
            const title = document.getElementById('editPostTitle').value.trim();
            const content = document.getElementById('editPostContent').value.trim();
            const translation = document.getElementById('editPostTranslation').value.trim();
            const link = document.getElementById('editPostLink').value.trim();
            const linkTxt = document.getElementById('editPostLinkTxt').value.trim();
            const fileInput = document.getElementById('editPostImg').files[0];
            
            if (!title) {
                alert('‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!');
                return;
            }

            const btn = document.querySelector('#modal-edit-post .btn-success');
            const originalText = btn.innerText;
            btn.innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            btn.disabled = true;

            try {
                let updates = {
                    t: title,
                    c: content,
                    bnTranslation: translation,
                    link: link,
                    linkTxt: linkTxt,
                    updatedAt: Date.now()
                };

                // Upload new image if provided
                if (fileInput) {
                    btn.innerText = "‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                    const imgUrl = await uploadImg(fileInput);
                    if (imgUrl) {
                        updates.img = imgUrl;
                    }
                }

                await db.ref('posts/' + postId).update(updates);
                
                alert('‚úÖ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
                closeModal();
                renderApp();
                
            } catch (error) {
                console.error("Post update error:", error);
                alert("‚ùå ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: " + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deletePost(postId) {
            if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§')) {
                return;
            }

            try {
                await db.ref('posts/' + postId).remove();
                alert('‚úÖ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
                renderApp();
            } catch (error) {
                console.error('Delete post error:', error);
                alert('‚ùå ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: ' + error.message);
            }
        }
// ==================== EXAM MANAGEMENT FUNCTIONS ====================

// ‡ßß. ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
// ==================== EXAM SYSTEM (FIXED) ====================

// ‡ßß. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶è‡¶¨‡¶Ç ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶™‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (FIXED for Edit)
function addQ(data = null) {
    const container = document.getElementById('qList');
    
    const div = document.createElement('div');
    div.className = 'card q-item';
    div.style.border = '1px solid #ddd';
    div.style.padding = '10px';
    div.style.marginBottom = '10px';

    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ö‡ßá‡¶ï (‡¶Ø‡¶¶‡¶ø ‡¶è‡¶°‡¶ø‡¶ü ‡¶Æ‡ßã‡¶° ‡¶π‡ßü)
    const val = data ? data.val : '';
    const type = data ? data.type : 'text';
    const ans = data ? data.ans : 0;
    const opts = data ? data.opts : ['', '', '', ''];

    div.innerHTML = `
        <div class="flex flex-between mb-2">
            <span class="text-xs font-bold text-primary">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™</span>
            <button class="btn btn-sm btn-danger w-auto" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash"></i></button>
        </div>

        <div class="flex gap-2 mb-2">
            <div class="w-1/3">
                <label class="text-xs">Type</label>
                <select class="q-type">
                    <option value="text" ${type === 'text' ? 'selected' : ''}>Text</option>
                    <option value="image" ${type === 'image' ? 'selected' : ''}>Image URL</option>
                    <option value="html" ${type === 'html' ? 'selected' : ''}>HTML/Math</option>
                </select>
            </div>
            <div class="w-2/3">
                <label class="text-xs">Correct Answer</label>
                <select class="q-ans">
                    <option value="0" ${ans == 0 ? 'selected' : ''}>Option A</option>
                    <option value="1" ${ans == 1 ? 'selected' : ''}>Option B</option>
                    <option value="2" ${ans == 2 ? 'selected' : ''}>Option C</option>
                    <option value="3" ${ans == 3 ? 'selected' : ''}>Option D</option>
                </select>
            </div>
        </div>

        <label class="text-xs">Question</label>
        <textarea class="q-val mb-2" rows="2" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï...">${val}</textarea>

        <div class="grid grid-cols-2 gap-2">
            <input type="text" class="q-opt-0" placeholder="Option A" value="${opts[0]}">
            <input type="text" class="q-opt-1" placeholder="Option B" value="${opts[1]}">
            <input type="text" class="q-opt-2" placeholder="Option C" value="${opts[2]}">
            <input type="text" class="q-opt-3" placeholder="Option D" value="${opts[3]}">
        </div>
    `;

    container.appendChild(div);
}

// ‡ß®. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (FIXED loading questions)
async function editExam(id) {
    const snap = await db.ref('exams/' + id).once('value');
    const exam = snap.val();
    
    if (!exam) return alert("Exam not found!");

    // ‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡¶™‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('editExamId').value = id;
    document.getElementById('examModalTitle').innerText = "Edit Exam";
    document.getElementById('btnCancelEdit').classList.remove('hidden');

    document.getElementById('exTitle').value = exam.title;
    document.getElementById('exClass').value = exam.class;
    document.getElementById('exMode').value = exam.mode;
    document.getElementById('exStart').value = exam.start;
    document.getElementById('exEnd').value = exam.end;
    document.getElementById('exDur').value = exam.dur;
    document.getElementById('exFee').value = exam.fee;
    document.getElementById('exPrize').value = exam.prize || 0;
    document.getElementById('exGift').value = exam.giftAmount || 0;

    // ‡¶Æ‡ßã‡¶° ‡¶ü‡¶ó‡¶≤ ‡¶ï‡¶∞‡¶æ
    const nativeDiv = document.getElementById('nativeMode');
    const googleDiv = document.getElementById('googleMode');
    
    if (exam.mode === 'Google') {
        nativeDiv.classList.add('hidden');
        googleDiv.classList.remove('hidden');
        document.getElementById('exLink').value = exam.link || '';
    } else {
        nativeDiv.classList.remove('hidden');
        googleDiv.classList.add('hidden');
        
        // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶∞‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
        const qList = document.getElementById('qList');
        qList.innerHTML = ''; 
        
        if (exam.questions && Array.isArray(exam.questions)) {
            exam.questions.forEach(q => {
                addQ(q); // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            });
        }
    }
    
    // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤ ‡¶ï‡¶∞‡ßá ‡¶â‡¶™‡¶∞‡ßá ‡¶Ø‡¶æ‡¶ì‡ßü‡¶æ
    document.getElementById('adm-exam').scrollIntoView({ behavior: 'smooth' });
}

// ‡ß©. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function saveExam() {
    const title = document.getElementById('exTitle').value.trim();
    const mode = document.getElementById('exMode').value;
    const cls = document.getElementById('exClass').value;
    const start = document.getElementById('exStart').value;
    const end = document.getElementById('exEnd').value;
    const dur = parseInt(document.getElementById('exDur').value);
    const fee = parseInt(document.getElementById('exFee').value) || 0;
    const prize = parseInt(document.getElementById('exPrize').value) || 0;
    const gift = parseInt(document.getElementById('exGift').value) || 0;
    
    if (!title || !start || !end || !dur) return alert("All fields required");

    let data = {
        title, mode, class: cls, start, end, dur, fee, prize, giftAmount: gift,
        created: Date.now()
    };

    if (mode === 'Google') {
        data.link = document.getElementById('exLink').value;
    } else {
        // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
        let questions = [];
        document.querySelectorAll('.q-item').forEach(item => {
            const type = item.querySelector('.q-type').value;
            const val = item.querySelector('.q-val').value;
            const ans = item.querySelector('.q-ans').value;
            const o0 = item.querySelector('.q-opt-0').value;
            const o1 = item.querySelector('.q-opt-1').value;
            const o2 = item.querySelector('.q-opt-2').value;
            const o3 = item.querySelector('.q-opt-3').value;

            if(val) {
                questions.push({
                    type: type,
                    val: val,
                    ans: ans,
                    opts: [o0, o1, o2, o3]
                });
            }
        });
        
        if(questions.length === 0) return alert("Add at least one question!");
        data.questions = questions;
    }

    const editId = document.getElementById('editExamId').value;
    
    if (editId) {
        await db.ref('exams/' + editId).update(data);
        alert("‚úÖ Updated Successfully");
    } else {
        await db.ref('exams').push(data);
        alert("‚úÖ Created Successfully");
    }

    // Reset UI
    cancelEditExam();
    renderAdminExams();
}

// ‡ß™. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶∏‡ßá‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function cancelEditExam() {
    document.getElementById('editExamId').value = '';
    document.getElementById('examModalTitle').innerText = "Create Exam";
    document.getElementById('btnCancelEdit').classList.add('hidden');
    document.getElementById('exTitle').value = '';
    document.getElementById('qList').innerHTML = '';
}

// ‡ß´. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶ú‡ßü‡ßá‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (FIXED)
async function startExam(examId) {
    if(!CURR_USER) return alert("Please login first");

    const snap = await db.ref('exams/' + examId).once('value');
    const exam = snap.val();
    
    if(!exam) return alert("Exam not found or deleted");

    // ‡¶∏‡¶Æ‡ßü ‡¶ö‡ßá‡¶ï
    const now = new Date();
    const start = new Date(exam.start);
    const end = new Date(exam.end);

    if (now < start) return alert("Exam has not started yet!");
    if (now > end) return alert("Exam has ended!");

    // ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï
    const userClass = CURR_USER.class || 'Class 10';
    if(exam.class !== 'All' && exam.class !== userClass) {
        return alert(`This exam is only for ${exam.class}`);
    }

    // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶ö‡ßá‡¶ï (‡¶Ü‡¶ó‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ)
    const resSnap = await db.ref('results').orderByChild('uid').equalTo(CURR_USER.id).once('value');
    let alreadyTaken = false;
    resSnap.forEach(child => {
        if(child.val().eid === examId) alreadyTaken = true;
    });

    if(alreadyTaken) return alert("You have already taken this exam!");

    // ‡¶´‡¶ø ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü
    if(exam.fee > 0) {
        if(CURR_USER.bal < exam.fee) return alert("Insufficient Balance! Please Deposit.");
        
        if(!confirm(`Exam Fee: ‡ß≥${exam.fee}. Do you want to continue?`)) return;
        
        // ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ
        await db.ref('users/' + CURR_USER.id + '/bal').set(CURR_USER.bal - exam.fee);
        CURR_USER.bal -= exam.fee;
        updateUserUI();
    }

    // ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ
    if(exam.mode === 'Google') {
        window.open(exam.link, '_blank');
    } else {
        ACTIVE_EXAM = { id: examId, ...exam };
        startExamUI();
    }
}

// ‡ß¨. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ UI ‡¶è‡¶¨‡¶Ç MathJax (FIXED)
function startExamUI() {
    document.getElementById('runExamTitle').innerText = ACTIVE_EXAM.title;
    const examBody = document.getElementById('examBody');
    examBody.innerHTML = '';

    if (ACTIVE_EXAM.questions) {
        ACTIVE_EXAM.questions.forEach((q, i) => {
            let qHtml = '';
            
            // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
            if (q.type === 'image') {
                qHtml = `<div class="mb-2"><b>Q${i+1}:</b></div><img src="${q.val}" class="q-img" style="max-width:100%">`;
            } else {
                qHtml = `<div class="mb-2"><b>Q${i+1}:</b> ${q.val}</div>`;
            }

            // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
            let optHtml = '';
            if(q.opts) {
                q.opts.forEach((opt, idx) => {
                    optHtml += `
                        <label class="mcq-opt">
                            <input type="radio" name="q${i}" value="${idx}">
                            <div style="width:100%">${opt}</div>
                        </label>
                    `;
                });
            }

            examBody.innerHTML += `
                <div class="card" style="margin-bottom: 20px;">
                    ${qHtml}
                    <div class="mt-2">${optHtml}</div>
                </div>
            `;
        });
    }

    document.getElementById('modal-exam').classList.remove('hidden');

    // ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞
    let timeLeft = (ACTIVE_EXAM.dur || 10) * 60;
    updateTimerDisplay(timeLeft);
    
    if(TIMER_INT) clearInterval(TIMER_INT);
    TIMER_INT = setInterval(() => {
        timeLeft--;
        updateTimerDisplay(timeLeft);
        if(timeLeft <= 0) {
            clearInterval(TIMER_INT);
            submitExam();
        }
    }, 1000);

    // MathJax ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
    if(window.MathJax) {
        setTimeout(() => {
            MathJax.typesetPromise();
        }, 500);
    }
}


// ‡ß®. ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶ï‡¶∞‡¶≤‡ßá ‡¶π‡¶ø‡¶®‡ßç‡¶ü ‡¶¨‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (Optional UX)
function toggleQInput(selectElem) {
    const wrapper = selectElem.closest('.q-item');
    const helper = wrapper.querySelector('.helper-text');
    
    if (selectElem.value === 'image') {
        helper.innerText = '‡¶ü‡¶ø‡¶™‡¶∏: ImgBB ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶Æ‡ßá‡¶ú‡ßá‡¶∞ ‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
    } else if (selectElem.value === 'html') {
        helper.innerText = '‡¶ü‡¶ø‡¶™‡¶∏: <b>Bold</b>, <i>Italic</i> ‡¶¨‡¶æ MathJax ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§';
    } else {
        helper.innerText = '';
    }
}

// ‡ß©. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Bug Fixed)
async function saveExam() {
    const title = document.getElementById('exTitle').value.trim();
    const mode = document.getElementById('exMode').value;
    const cls = document.getElementById('exClass').value;
    const start = document.getElementById('exStart').value;
    const end = document.getElementById('exEnd').value;
    const dur = parseInt(document.getElementById('exDur').value);
    const fee = parseInt(document.getElementById('exFee').value) || 0;
    const prize = parseInt(document.getElementById('exPrize').value) || 0;
    const gift = parseInt(document.getElementById('exGift').value) || 0;
    
    // Validation
    if (!title || !start || !end || !dur) {
        alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤, ‡¶∏‡¶Æ‡ßü ‡¶è‡¶¨‡¶Ç ‡¶°‡¶ø‡¶â‡¶∞‡ßá‡¶∂‡¶® ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        return;
    }

    let examData = {
        title: title,
        mode: mode,
        class: cls,
        start: start,
        end: end,
        dur: dur,
        fee: fee,
        prize: prize,
        giftAmount: gift,
        created: Date.now()
    };

    if (mode === 'Google') {
        const link = document.getElementById('exLink').value.trim();
        if (!link) return alert("‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶¶‡¶ø‡¶®");
        examData.link = link;
    } else {
        // Native Questions Collection
        const qElements = document.querySelectorAll('.q-item');
        let questions = [];

        qElements.forEach(el => {
            const type = el.querySelector('.q-type').value;
            const val = el.querySelector('.q-val').value.trim();
            const ans = el.querySelector('.q-ans').value;
            const opt0 = el.querySelector('.q-opt-0').value.trim();
            const opt1 = el.querySelector('.q-opt-1').value.trim();
            const opt2 = el.querySelector('.q-opt-2').value.trim();
            const opt3 = el.querySelector('.q-opt-3').value.trim();

            if (val && opt0 && opt1) { // ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶è‡¶¨‡¶Ç ‡ß®‡¶ü‡¶æ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá
                questions.push({
                    type: type,
                    val: val,
                    ans: parseInt(ans),
                    opts: [opt0, opt1, opt2, opt3]
                });
            }
        });

        if (questions.length === 0) {
            return alert("‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ßß‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®!");
        }
        examData.questions = questions;
    }

    const btn = document.getElementById('btnSave');
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        const editId = document.getElementById('editExamId').value;
        
        if (editId) {
            // Update existing exam
            await db.ref('exams/' + editId).update(examData);
            alert("‚úÖ ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        } else {
            // Create new exam
            await db.ref('exams').push(examData);
            alert("‚úÖ ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }
        
        // Reset Form
        document.getElementById('exTitle').value = '';
        document.getElementById('qList').innerHTML = '';
        document.getElementById('editExamId').value = '';
        document.getElementById('btnCancelEdit').classList.add('hidden');
        document.getElementById('examModalTitle').innerText = "Create Exam";
        
        renderAdminExams(); // ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü

    } catch (error) {
        console.error(error);
        alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡¶®‡¶ø: " + error.message);
    } finally {
        btn.innerText = "Save Exam";
        btn.disabled = false;
    }
}

        async function saveTranslation(postId) {
            if (CURR_USER?.role !== 'admin') return;
            
            const translationText = document.getElementById('admin-translation-' + postId).value.trim();
            
            try {
                await db.ref('posts/' + postId + '/bnTranslation').set(translationText);
                
                // Update UI
                const translationDiv = document.getElementById('translation-' + postId);
                if (translationDiv) {
                    if (translationText) {
                        translationDiv.innerHTML = `<strong><i class="fas fa-language"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶:</strong><br>${translationText}`;
                        translationDiv.classList.add('show');
                    } else {
                        translationDiv.remove();
                    }
                } else if (translationText) {
                    // Create new translation div if it doesn't exist
                    const contentDiv = document.getElementById('post-content-' + postId);
                    const newTranslationDiv = document.createElement('div');
                    newTranslationDiv.className = 'post-translation show';
                    newTranslationDiv.id = 'translation-' + postId;
                    newTranslationDiv.innerHTML = `<strong><i class="fas fa-language"></i> ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶:</strong><br>${translationText}`;
                    
                    // Insert before admin translation box
                    const adminBox = contentDiv.querySelector('.admin-translation-box');
                    if (adminBox) {
                        contentDiv.insertBefore(newTranslationDiv, adminBox);
                    }
                }
                
                // Update button text if it exists
                const translateBtn = document.querySelector(`button[onclick*="${postId}"]`);
                if (translateBtn && !translationText) {
                    translateBtn.remove();
                }
                
                alert('‚úÖ ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
            } catch (error) {
                console.error('Translation save error:', error);
                alert('‚ùå ‡¶Ö‡¶®‡ßÅ‡¶¨‡¶æ‡¶¶ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: ' + error.message);
            }
        }

      // ==================== ADVANCED EXAM RENDERER ====================
// ==================== COMPLETE EXAM SYSTEM v6.2 ====================

// ‡ßß. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
function renderExams() {
    const container = document.getElementById('examList');
    if (!container || !DB_DATA || !DB_DATA.exams) return;
    
    container.innerHTML = '';
    const now = new Date();
    const userClass = CURR_USER.class || 'Class 10';
    const allResults = DB_DATA.results || {};

    // Sort: Newest exams first
    const sortedExams = Object.entries(DB_DATA.exams).sort(([,a], [,b]) => {
        return new Date(b.start) - new Date(a.start);
    });

    sortedExams.forEach(([id, exam]) => {
        // --- CALCULATION SECTION ---
        const start = new Date(exam.start);
        const end = new Date(exam.end);
        
        // Status Determination
        let status = 'Upcoming';
        let badgeClass = 'ec-upcoming';
        
        if (now >= start && now <= end) {
            status = 'Live';
            badgeClass = 'ec-live';
        } else if (now > end) {
            status = 'Ended';
            badgeClass = 'ec-ended';
        }

        // Check if user joined
        const myResult = Object.values(allResults).find(r => r.eid === id && r.uid === CURR_USER.id);
        const isJoined = !!myResult;
        
        // Total Students Count
        const totalParticipants = Object.values(allResults).filter(r => r.eid === id).length;

        // Date Formatting
        const fmt = (d) => d.toLocaleString('en-US', { day: 'numeric', month: 'short', hour: 'numeric', minute: '2-digit', hour12: true });

        // --- UI GENERATION SECTION ---

        // 1. User Score Box (Only if joined)
        let scoreUI = '';
        if (isJoined) {
            scoreUI = `
                <div class="ec-score-box">
                    <div>
                        <div style="font-size:0.75rem; opacity:0.9;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</div>
                        <div style="font-size:1.4rem; font-weight:800;">${myResult.score} / ${myResult.total}</div>
                    </div>
                    <div class="text-right">
                        <div style="font-size:0.75rem;">Status</div>
                        <div style="font-weight:bold; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">Joined</div>
                    </div>
                </div>
            `;
        }

        // 2. Action Buttons Logic
        let buttonsUI = '';
        
        // Button: Leaderboard (Always show if exam started)
        if (status !== 'Upcoming') {
            buttonsUI += `
                <button class="btn btn-soft w-auto" onclick="viewLeaderboard('${id}')" style="flex:1;">
                    <i class="fas fa-users"></i> List (${totalParticipants})
                </button>
            `;
        } else {
             buttonsUI += `
                <button class="btn btn-soft w-auto" disabled style="flex:1;">
                    <i class="fas fa-clock"></i> Wait for start
                </button>
            `;
        }

        // Button: Main Action (Start / View Result)
        if (isJoined) {
            if (status === 'Ended') {
                buttonsUI += `
                    <button class="btn btn-primary w-auto" onclick="viewExamResult('${id}')" style="flex:1;">
                        <i class="fas fa-eye"></i> ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞
                    </button>
                `;
            } else {
                buttonsUI += `
                    <button class="btn btn-outline w-auto" disabled style="flex:1;">
                        <i class="fas fa-check"></i> Running
                    </button>
                `;
            }
        } else {
            // Not joined yet
            if (status === 'Live') {
                // Class check
                if (exam.class === 'All' || exam.class === userClass) {
                    buttonsUI += `
                        <button class="btn btn-danger w-auto" onclick="startExam('${id}')" style="flex:1;">
                            <i class="fas fa-play"></i> Start Exam
                        </button>
                    `;
                } else {
                    buttonsUI += `<button class="btn btn-soft" disabled style="flex:1;">For ${exam.class}</button>`;
                }
            } else if (status === 'Ended') {
                 buttonsUI += `<button class="btn btn-soft" disabled style="flex:1;">Exam Over</button>`;
            }
        }

        // --- FINAL CARD HTML ---
        container.innerHTML += `
            <div class="exam-card-adv">
                <div class="ec-header">
                    <div class="flex gap-2 items-center">
                        <i class="fas fa-graduation-cap text-primary"></i>
                        <span style="font-weight:600; font-size:0.8rem; color:#64748b;">${id}</span>
                    </div>
                    <span class="ec-badge ${badgeClass}">${status}</span>
                </div>

                <div class="ec-body">
                    <h3 class="ec-title">${exam.title}</h3>
                    <div class="ec-sub">
                        <span class="ec-tag">${exam.class}</span>
                        <span class="ec-tag">Duration: ${exam.dur} min</span>
                        <span class="ec-tag">Fee: ${exam.fee > 0 ? '‡ß≥'+exam.fee : 'Free'}</span>
                    </div>

                    ${scoreUI}

                    <div class="ec-grid">
                        <div class="ec-grid-item">
                            <span>Start Time</span>
                            <b>${fmt(start)}</b>
                        </div>
                        <div class="ec-grid-item" style="text-align:right;">
                            <span>End Time</span>
                            <b>${fmt(end)}</b>
                        </div>
                    </div>
                </div>

                <div class="ec-footer">
                    ${buttonsUI}
                </div>
            </div>
        `;
    });

    if(sortedExams.length === 0) {
        container.innerHTML = '<div class="text-center p-4 text-light">No exams found.</div>';
    }
}

// ‡ß®. ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶° (Joined Students List) ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function viewLeaderboard(eid) {
    // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶°
    const resSnap = await db.ref('results').orderByChild('eid').equalTo(eid).once('value');
    const results = resSnap.val();
    
    // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶á‡¶®‡¶´‡ßã ‡¶≤‡ßã‡¶° (‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
    const userSnap = await db.ref('users').once('value');
    const allUsers = userSnap.val() || {};

    const container = document.getElementById('leaderboardBody');
    container.innerHTML = '';

    if (!results) {
        container.innerHTML = '<div class="text-center p-4">‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßá‡¶â ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá‡¶®‡¶ø‡•§</div>';
        document.getElementById('modal-leaderboard').classList.remove('hidden');
        return;
    }

    // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∞‡ßá‡¶§‡ßá ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶∞‡ßç‡¶ü (‡¶¨‡ßá‡¶∂‡¶ø ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶ó‡ßá)
    const sortedList = Object.values(results).sort((a, b) => {
        if (b.score === a.score) return a.timestamp - b.timestamp; // ‡¶ü‡¶æ‡¶á ‡¶π‡¶≤‡ßá ‡¶Ø‡ßá ‡¶Ü‡¶ó‡ßá ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá
        return b.score - a.score;
    });

    // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
    sortedList.forEach((res, index) => {
        const student = allUsers[res.uid] || { name: 'Unknown', avatar: '' };
        const isMe = res.uid === CURR_USER.id ? 'background:#f0fdf4;' : '';
        
        container.innerHTML += `
            <div class="lb-row" style="${isMe}">
                <div class="flex gap-3">
                    <div class="lb-rank">${index + 1}</div>
                    <div>
                        <div class="lb-name">${student.name} ${res.uid === CURR_USER.id ? '(You)' : ''}</div>
                        <div class="text-xs text-light">${res.uid.substr(0,5)}***</div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="lb-score">${res.score}/${res.total}</div>
                    <div class="text-xs text-light">${res.percentage}%</div>
                </div>
            </div>
        `;
    });

    document.getElementById('modal-leaderboard').classList.remove('hidden');
}

// ‡ß©. ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶ì ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        function renderLibrary() {
            const container = document.getElementById('libList');
            if (!container || !DB_DATA || !DB_DATA.library) return;
            
            container.innerHTML = '';
            const library = DB_DATA.library;
            
            if (Object.keys(library).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No library items yet</p></div>';
                return;
            }
            
            Object.values(library).forEach(item => {
                container.innerHTML += `
                    <div class="card flex flex-between">
                        <div class="flex gap-2">
                            <i class="fas ${item.type === 'Video' ? 'fa-video' : 'fa-file-pdf'} fa-2x ${item.type === 'Video' ? 'text-danger' : 'text-primary'}"></i>
                            <div>
                                <b>${item.title}</b>
                                <div class="text-xs text-light">${item.type}</div>
                            </div>
                        </div>
                        <a href="${item.link}" target="_blank" class="btn btn-sm btn-outline">Open</a>
                    </div>
                `;
            });
        }

        function renderTransactions() {
            const container = document.getElementById('txHistory');
            if (!container || !DB_DATA || !DB_DATA.txs) return;
            
            container.innerHTML = '';
            const transactions = DB_DATA.txs;
            
            if (Object.keys(transactions).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No transactions yet</p></div>';
                return;
            }
            
            Object.entries(transactions)
                .filter(([, t]) => t.uid === CURR_USER.id)
                .sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0))
                .forEach(([id, t]) => {
                    container.innerHTML += `
                        <div class="card p-2 flex flex-between">
                            <div>
                                <div class="font-bold text-xs">${t.type}</div>
                                <div class="text-xs text-light">${t.method || ''} ${t.trx ? '| ' + t.trx : ''}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">‡ß≥${t.amount}</div>
                                <div class="status-badge st-${t.status}">${t.status}</div>
                            </div>
                        </div>
                    `;
                });
        }

        function renderMessages() {
            const container = document.getElementById('userMsgList');
            if (!container || !DB_DATA || !DB_DATA.msgs) return;
            
            container.innerHTML = '';
            const messages = DB_DATA.msgs;
            
            if (Object.keys(messages).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No messages yet</p></div>';
                return;
            }
            
            Object.entries(messages)
                .filter(([, m]) => m.uid === CURR_USER.id)
                .sort(([, a], [, b]) => (b.time || 0) - (a.time || 0))
                .forEach(([id, m]) => {
                    container.innerHTML += `
                        <div class="msg-box">
                            <div class="text-sm font-bold text-light">You: ${m.text}</div>
                            ${m.reply ? `<div class="admin-reply"><b>Admin:</b> ${m.reply}</div>` : '<div class="text-xs text-light mt-1">Waiting for reply</div>'}
                        </div>
                    `;
                });
        }

        // ==================== ADMIN FUNCTIONS ====================
        async function renderAdminDashboard() {
            if (!DB_DATA) return;
            
            renderAdminUsers();
            renderAdminPayments();
            renderAdminMessages();
            renderAdminExams();
            renderAllPosts();
        }
// ==================== ADMIN MESSAGE FUNCTIONS ====================

// ‡ß©. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü (Admin View)
function renderAdminMessages() {
    const container = document.getElementById('admMsgList');
    if (!container || !DB_DATA || !DB_DATA.msgs) {
        container.innerHTML = '<p class="text-center text-light">‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶®‡ßá‡¶á</p>';
        return;
    }
    
    container.innerHTML = '';
    
    // ‡¶∏‡¶¨ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° (‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶ó‡ßá)
    const allMsgs = Object.entries(DB_DATA.msgs).sort(([, a], [, b]) => b.time - a.time);
    
    allMsgs.forEach(([id, m]) => {
        const timeStr = new Date(m.time).toLocaleDateString() + ' ' + new Date(m.time).toLocaleTimeString();
        
        container.innerHTML += `
            <div class="card" style="border-left: 3px solid ${m.reply ? '#10b981' : '#f59e0b'};">
                <div class="flex flex-between mb-1">
                    <div>
                        <b style="font-size:0.9rem;">${m.name}</b>
                        <span class="text-xs text-light">(${m.uid})</span>
                    </div>
                    <span class="text-xs text-light">${timeStr}</span>
                </div>
                
                <div class="bg-gray-50 p-2 rounded mb-2 text-sm">
                    ${m.text}
                </div>

                ${m.reply ? `
                    <div class="text-xs text-success">
                        <i class="fas fa-check-circle"></i> ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: ${m.reply}
                    </div>
                ` : `
                    <div class="flex gap-2">
                        <input type="text" id="rep-${id}" placeholder="‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="margin-bottom:0; font-size:0.85rem;">
                        <button class="btn btn-sm w-auto" onclick="admReply('${id}')">Send</button>
                    </div>
                `}
            </div>
        `;
    });
}

// ‡ß™. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶≤‡¶ú‡¶ø‡¶ï
async function admReply(msgId) {
    const input = document.getElementById(`rep-${msgId}`);
    const replyText = input.value.trim();
    
    if (!replyText) return alert("‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!");

    const btn = input.nextElementSibling;
    btn.innerText = "...";
    btn.disabled = true;

    try {
        // ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        await db.ref('msgs/' + msgId).update({
            reply: replyText
        });

        // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        if (DB_DATA.msgs && DB_DATA.msgs[msgId]) {
            DB_DATA.msgs[msgId].reply = replyText;
        }

        alert("‚úÖ ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        renderAdminMessages(); // ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂

    } catch (error) {
        console.error(error);
        alert("‡¶è‡¶∞‡¶∞: " + error.message);
    }
}

        function renderAllPosts() {
            const container = document.getElementById('allPostsList');
            if (!container || !DB_DATA || !DB_DATA.posts) return;
            
            container.innerHTML = '';
            const posts = DB_DATA.posts;
            
            if (Object.keys(posts).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No posts yet</p></div>';
                return;
            }
            
            Object.entries(posts)
                .sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0))
                .forEach(([id, post]) => {
                    const dateStr = post.timestamp ? new Date(post.timestamp).toLocaleDateString('bn-BD', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    }) : '';
                    
                    const shortContent = (post.c || '').substring(0, 100) + ((post.c || '').length > 100 ? '...' : '');
                    
                    container.innerHTML += `
                        <div class="card mb-3">
                            <div class="flex flex-between items-start">
                                <div style="flex: 1;">
                                    <b>${post.t || post.title || 'Untitled'}</b>
                                    <div class="text-xs text-light mb-2">${dateStr}</div>
                                    <div class="text-sm text-light" style="white-space: pre-wrap;">${shortContent}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm" onclick="editPost('${id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePost('${id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }

        function renderAdminUsers() {
            const container = document.getElementById('admUserList');
            if (!container || !DB_DATA || !DB_DATA.users) return;
            
            container.innerHTML = '';
            const users = DB_DATA.users;
            
            const students = Object.entries(users)
                .filter(([mobile, user]) => user.role === 'student')
                .sort(([, a], [, b]) => a.name.localeCompare(b.name));
            
            if (students.length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No students found</p></div>';
                return;
            }
            
            students.forEach(([mobile, user]) => {
                container.innerHTML += `
                    <div class="card student-card">
                        <div class="flex gap-3 items-center">
                            <img src="${user.avatar || 'https://via.placeholder.com/50'}" 
                                 class="profile-pic-small"
                                 onerror="this.src='https://via.placeholder.com/50'">
                            <div class="flex-1">
                                <div class="flex flex-between items-start">
                                    <div>
                                        <b>${user.name}</b>
                                        <div class="text-xs text-light">${mobile}</div>
                                    </div>
                                    <span class="font-bold text-primary">‡ß≥${user.bal || 0}</span>
                                </div>
                                <div class="flex flex-between items-center mt-2">
                                    <span class="class-badge">${user.class || 'Not set'}</span>
                                    <div class="flex gap-2">
                                        <button class="btn btn-sm btn-outline" onclick="editStudent('${mobile}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteStudent('${mobile}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
function editStudent(mobile) {
    // ‡ßß. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ
    const user = DB_DATA.users[mobile];
    
    if (!user) {
        alert("User data not found!");
        return;
    }

    // ‡ß®. ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶´‡¶ø‡¶≤‡ßç‡¶°‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('editUserMobile').value = mobile; // ‡¶π‡¶ø‡¶°‡ßá‡¶® ‡¶á‡¶®‡¶™‡ßÅ‡¶ü (ID ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
    document.getElementById('editUserName').value = user.name;
    document.getElementById('editUserClass').value = user.class || 'Class 10';
    document.getElementById('editUserBal').value = user.bal;
    document.getElementById('editUserPass').value = user.pass;
    
    // ‡¶õ‡¶¨‡¶ø ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    const imgPreview = document.getElementById('editUserAvatar');
    if (imgPreview) {
        imgPreview.src = user.avatar || 'https://via.placeholder.com/50';
    }
    
    // ‡¶´‡¶æ‡¶á‡¶≤ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('editUserPicFile').value = '';

    // ‡ß©. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
    showModal('edit-user');
}

        function renderAdminPayments() {
            const pendingList = document.getElementById('admPayList');
            const historyList = document.getElementById('admPayHistory');
            
            if (!pendingList || !historyList || !DB_DATA || !DB_DATA.txs) return;
            
            pendingList.innerHTML = '';
            historyList.innerHTML = '';
            
            const transactions = DB_DATA.txs;
            
            if (Object.keys(transactions).length === 0) return;
            
            Object.entries(transactions)
                .sort(([, a], [, b]) => (b.timestamp || 0) - (a.timestamp || 0))
                .forEach(([id, t]) => {
                    const html = `
                        <div class="card">
                            <div class="flex flex-between">
                                <div>
                                    <b>${t.type}</b>
                                    <div class="text-xs text-light">${t.uid} | ${t.method || ''}</div>
                                </div>
                                <b>‡ß≥${t.amount}</b>
                            </div>
                            <div class="text-xs text-light mb-2">${t.trx || ''}</div>
                            <div class="status-badge st-${t.status}">${t.status}</div>
                            ${t.status === 'Pending' ? `
                                <div class="flex gap-2 mt-2">
                                    <button class="btn btn-success btn-sm" onclick="admTx('${id}', true)">
                                        Approve
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="admTx('${id}', false)">
                                        Reject
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    if (t.status === 'Pending') {
                        pendingList.innerHTML += html;
                    } else {
                        historyList.innerHTML += html;
                    }
                });
        }

        function renderAdminMessages() {
            const container = document.getElementById('admMsgList');
            if (!container || !DB_DATA || !DB_DATA.msgs) return;
            
            container.innerHTML = '';
            const messages = DB_DATA.msgs;
            
            if (Object.keys(messages).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No messages yet</p></div>';
                return;
            }
            
            Object.entries(messages)
                .sort(([, a], [, b]) => (b.time || 0) - (a.time || 0))
                .forEach(([id, m]) => {
                    container.innerHTML += `
                        <div class="card">
                            <div class="font-bold text-sm mb-1">
                                ${m.name} <small class="text-light">(${m.uid})</small>
                            </div>
                            <div class="bg-gray-50 p-2 rounded mb-2">${m.text}</div>
                            ${m.reply ? 
                                `<div class="admin-reply">Reply: ${m.reply}</div>` :
                                `<div class="flex gap-2">
                                    <input type="text" id="rep-${id}" placeholder="Reply..." style="margin-bottom:0">
                                    <button class="btn btn-sm w-auto" onclick="admReply('${id}')">Send</button>
                                </div>`
                            }
                        </div>
                    `;
                });
        }

        function renderAdminExams() {
            const container = document.getElementById('admExList');
            if (!container || !DB_DATA || !DB_DATA.exams) return;
            
            container.innerHTML = '';
            const exams = DB_DATA.exams;
            
            if (Object.keys(exams).length === 0) {
                container.innerHTML = '<div class="card text-center p-4"><p class="text-light">No exams created yet</p></div>';
                return;
            }
            
            Object.entries(exams).forEach(([id, exam]) => {
                container.innerHTML += `
                    <div class="card flex flex-between">
                        <div>
                            <b>${exam.title}</b>
                            <div class="text-xs text-light">${exam.class} | ${exam.mode} | Fee: ‡ß≥${exam.fee || 0} | Prize: ‡ß≥${exam.prize || 0}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm" onclick="editExam('${id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="viewAttendees('${id}')">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteExam('${id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
        }
// ==================== VIEW ATTENDEES (ADMIN) ====================
async function viewAttendees(examId) {
    // Button loading effect
    const btn = document.activeElement; // Je button e click kora hoyeche
    let oldIcon = '';
    if(btn) {
        oldIcon = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
    }

    try {
        // 1. Result data ana
        const resSnap = await db.ref('results').orderByChild('eid').equalTo(examId).once('value');
        const results = resSnap.val();

        // 2. Exam details ana (Title er jonno)
        const examSnap = await db.ref('exams/' + examId).once('value');
        const exam = examSnap.val();
        const examTitle = exam ? exam.title : 'Exam';

        // 3. User details ana (Nam er jonno)
        const userSnap = await db.ref('users').once('value');
        const allUsers = userSnap.val() || {};

        const container = document.getElementById('attendeeListContent');
        const titleElem = document.getElementById('attendeeTitle');
        
        if(titleElem) titleElem.innerText = `${examTitle} - Participants`;

        if (!results) {
            container.innerHTML = '<div class="text-center p-4 text-light">Ekhono keu ongshogrohon koreni.</div>';
            showModal('attendees');
            return;
        }

        // 4. List toiri kora
        let html = `
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead style="background: #f3f4f6; text-align: left; position: sticky; top: 0;">
                        <tr>
                            <th style="padding: 10px; border-bottom: 2px solid #ddd;">Rank</th>
                            <th style="padding: 10px; border-bottom: 2px solid #ddd;">Name & ID</th>
                            <th style="padding: 10px; border-bottom: 2px solid #ddd; text-align:right;">Score</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Score onujayi sort kora (High score first)
        const sortedList = Object.values(results).sort((a, b) => b.score - a.score);

        sortedList.forEach((res, index) => {
            const student = allUsers[res.uid] || { name: 'Unknown', mobile: res.uid };
            
            // Rank Badge Logic
            let rank = index + 1;
            let rankStyle = 'background:#e0e7ff; color:#4338ca;';
            if(rank === 1) rankStyle = 'background:#fef9c3; color:#a16207; border:1px solid #fde047;'; // Gold
            if(rank === 2) rankStyle = 'background:#f3f4f6; color:#4b5563; border:1px solid #d1d5db;'; // Silver
            if(rank === 3) rankStyle = 'background:#ffedd5; color:#9a3412; border:1px solid #fed7aa;'; // Bronze

            html += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">
                        <span style="display:inline-block; width:25px; height:25px; line-height:25px; text-align:center; border-radius:50%; font-weight:bold; font-size:0.8rem; ${rankStyle}">
                            ${rank}
                        </span>
                    </td>
                    <td style="padding: 10px;">
                        <div style="font-weight:600; color:#1e293b;">${student.name}</div>
                        <div style="font-size:0.75rem; color:#64748b;">${res.uid}</div>
                    </td>
                    <td style="padding: 10px; text-align:right;">
                        <div style="font-weight:bold; color:#16a34a; font-size:1rem;">${res.score}/${res.total}</div>
                        <div style="font-size:0.7rem; color:#94a3b8;">${res.percentage}%</div>
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table></div>`;
        container.innerHTML = html;

        // Modal open kora
        showModal('attendees');

    } catch (error) {
        console.error("Attendees Error:", error);
        alert("List load kora jacche na: " + error.message);
    } finally {
        // Button reset
        if(btn && oldIcon) {
            btn.innerHTML = oldIcon;
            btn.disabled = false;
        }
    }
}

        // ==================== ADMIN POST FUNCTIONS ====================
        async function admAddPost() {
            const title = document.getElementById('admPostTitle').value.trim();
            const content = document.getElementById('admPostContent').value.trim();
            const translation = document.getElementById('admPostTranslation').value.trim();
            const link = document.getElementById('admPostLink').value.trim();
            const linkTxt = document.getElementById('admPostLinkTxt').value.trim();
            const fileInput = document.getElementById('admPostImg');
            
            if (!title) {
                alert("‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶¶‡¶ø‡¶§‡ßá ‡¶π‡¶¨‡ßá!");
                return;
            }
const category = document.getElementById('admPostCategory').value;
            const btn = document.getElementById('btnPost');
            const oldText = btn.innerText;
            btn.innerText = "‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            btn.disabled = true;

            try {
                let imgUrl = "";

                if (fileInput.files.length > 0) {
                    btn.innerText = "‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                    imgUrl = await uploadImg(fileInput.files[0]);
                    if (!imgUrl) throw new Error("‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá");
                }

                const postData = {
                    t: title,
                    c: content,
                    category: category,
                    bnTranslation: translation,
                    img: imgUrl,
                    link: link,
                    linkTxt: linkTxt,
                    timestamp: Date.now()
                };

                await db.ref('posts').push(postData);
                
                alert("‚úÖ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                
                document.getElementById('admPostTitle').value = '';
                document.getElementById('admPostContent').value = '';
                document.getElementById('admPostTranslation').value = '';
                document.getElementById('admPostLink').value = '';
                document.getElementById('admPostLinkTxt').value = '';
                document.getElementById('admPostImg').value = '';

                renderApp();
                renderAllPosts();

            } catch (error) {
                console.error("Post Error:", error);
                alert("‚ùå ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: " + error.message);
            } finally {
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        async function admAddLib() {
            const title = document.getElementById('libTitle').value.trim();
            const link = document.getElementById('libLink').value.trim();
            const type = document.getElementById('libType').value;
            
            if (!title || !link) return alert("Info missing");
            
            await db.ref('library').push({
                title: title,
                link: link,
                type: type,
                added: Date.now()
            });
            
            alert("Library item added");
            renderApp();
        }

        async function admSaveSet() {
            const notice = document.getElementById('setNotice').value.trim();
            const bkash = document.getElementById('setBkash').value.trim();
            const nagad = document.getElementById('setNagad').value.trim();
            const minDep = parseInt(document.getElementById('setMinDep').value) || 50;
            const minWd = parseInt(document.getElementById('setMinWd').value) || 100;
            
            if (!notice) {
                alert("‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶ò‡¶∞‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ!");
                return;
            }

            const btn = document.querySelector('#adm-set button');
            const oldText = btn.innerText;
            btn.innerText = "‡¶∏‡ßá‡¶≠ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            btn.disabled = true;

            try {
                await db.ref('config').update({
                    notice: notice,
                    bkash: bkash,
                    nagad: nagad,
                    minDep: minDep,
                    minWd: minWd,
                    lastUpdated: Date.now()
                });

                document.getElementById('marqueeText').innerText = notice;
                
                if (DB_DATA && DB_DATA.config) {
                    DB_DATA.config.notice = notice;
                }

                alert("‚úÖ ‡¶®‡ßã‡¶ü‡¶ø‡¶∂ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");

            } catch (error) {
                console.error("Save Error:", error);
                alert("‚ùå ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡¶®‡¶ø: " + error.message);
            } finally {
                btn.innerText = oldText;
                btn.disabled = false;
            }
        }

        // ==================== WALLET FUNCTIONS ====================
        async function reqDep() {
            const amt = parseFloat(document.getElementById('depAmt').value);
            const method = document.getElementById('depMethod').value;
            const trx = document.getElementById('depTrx').value.trim();
            
            if (!amt || amt <= 0) return alert("‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®");
            if (!trx) return alert("Transaction ID ‡¶¶‡¶ø‡¶®");
            
            const config = DB_DATA?.config || {};
            if (config.minDep && amt < config.minDep) {
                return alert(`‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü: ‡ß≥${config.minDep}`);
            }
            
            await db.ref('txs').push({
                uid: CURR_USER.id,
                type: 'Deposit',
                amount: amt,
                method: method,
                trx: trx,
                status: 'Pending',
                timestamp: Date.now()
            });
            
            alert("‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            closeModal();
            renderApp();
        }

        async function reqWd() {
            const amt = parseFloat(document.getElementById('wdAmt').value);
            const method = document.getElementById('wdMethod').value;
            const num = document.getElementById('wdNum').value.trim();
            
            if (!amt || amt <= 0) return alert("‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®");
            if (!num) return alert("‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®");
            
            if (CURR_USER.bal < amt) return alert("‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á");
            
            const config = DB_DATA?.config || {};
            if (config.minWd && amt < config.minWd) {
                return alert(`‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: ‡ß≥${config.minWd}`);
            }
            
            await db.ref('txs').push({
                uid: CURR_USER.id,
                type: 'Withdraw',
                amount: amt,
                method: method,
                trx: num,
                status: 'Pending',
                timestamp: Date.now()
            });
            
            alert("‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
            closeModal();
            renderApp();
        }

        async function admTx(txId, approve) {
            const txRef = db.ref('txs/' + txId);
            const txSnap = await txRef.once('value');
            const tx = txSnap.val();
            
            if (!tx) return;
            
            const newStatus = approve ? 'Approved' : 'Rejected';
            await txRef.update({ status: newStatus });
            
            if (approve) {
                const userRef = db.ref('users/' + tx.uid + '/bal');
                const userSnap = await userRef.once('value');
                const currentBal = userSnap.val() || 0;
                
                if (tx.type === 'Deposit') {
                    await userRef.set(currentBal + tx.amount);
                } else if (tx.type === 'Withdraw') {
                    await userRef.set(currentBal - tx.amount);
                }
                
                if (CURR_USER.id === tx.uid) {
                    CURR_USER.bal = currentBal + (tx.type === 'Deposit' ? tx.amount : -tx.amount);
                }
            }
            
            alert(`Transaction ${newStatus}`);
            renderApp();
        }

        // ==================== UTILITY FUNCTIONS ====================
        async function uploadImg(file) {
            if (!file) return '';
            
            const formData = new FormData();
            formData.append("image", file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await response.json();
                return data.data.url;
            } catch (error) {
                console.error('Upload error:', error);
                return '';
            }
        }

        // ==================== NAVIGATION FUNCTION ====================
async function nav(v, el) {
    // ‡ßß. UI ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® (‡¶∏‡¶¨ ‡¶≠‡¶ø‡¶â ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã)
    document.querySelectorAll('.view').forEach(view => {
        view.classList.add('hidden');
    });
    document.getElementById('view-' + v).classList.remove('hidden');
    
    // ‡ß®. ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    if (el) {
        el.classList.add('active');
        // ‡¶π‡ßá‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        const text = el.innerText.trim();
        document.getElementById('headerTitle').innerText = text;
    }

    // ‡ß©. [‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£] ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶≤‡¶ú‡¶ø‡¶ï
    // ‡¶Ø‡¶ñ‡¶®‡¶á ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶¨
    if (['home', 'exam', 'wallet', 'admin'].includes(v)) {
        try {
            // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶è‡¶´‡ßá‡¶ï‡ßç‡¶ü (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤, ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶∞‡¶æ‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)
            // console.log("Refreshing data...");
            
            const snapshot = await db.ref().once('value');
            const data = snapshot.val();
            
            if (data) {
                DB_DATA = data; // ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
                
                // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶Ø‡¶¶‡¶ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
                if (DB_DATA.users && CURR_USER && DB_DATA.users[CURR_USER.id]) {
                    CURR_USER.bal = DB_DATA.users[CURR_USER.id].bal;
                    updateUserUI();
                }

                // ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø-‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
                if (v === 'exam') renderExams();
                if (v === 'wallet') renderTransactions();
                if (v === 'home') renderPosts(); // ‡¶Ø‡¶¶‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶•‡¶æ‡¶ï‡ßá
                if (v === 'admin' && CURR_USER.role === 'admin') renderAdminDashboard();
            }
        } catch (error) {
            console.error("Auto-refresh failed:", error);
        }
    }
}


        // ==================== ADMIN TAB NAVIGATION ====================
function admTab(t) {
    // ‡ßß. ‡¶∏‡¶¨ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶≤‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡¶æ
    document.querySelectorAll('.adm-sec').forEach(sec => {
        sec.classList.add('hidden');
    });

    // ‡ß®. ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
    const selectedSec = document.getElementById('adm-' + t);
    if (selectedSec) {
        selectedSec.classList.remove('hidden');
    }

    // ‡ß©. ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (Active State)
    // (‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶® ‡¶Ø‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶π‡¶æ‡¶á‡¶≤‡¶æ‡¶á‡¶ü ‡¶π‡¶¨‡ßá)
    const buttons = document.querySelectorAll('#view-admin .btn-sm');
    buttons.forEach(btn => {
        if(btn.innerText.toLowerCase().includes(t) || btn.getAttribute('onclick').includes(t)) {
            btn.classList.remove('btn-outline'); // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠
            btn.style.opacity = '1';
        } else {
            btn.style.opacity = '0.7';
        }
    });

    // ‡ß™. ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ (Data Refresh)
    switch (t) {
        case 'users':
            renderAdminUsers(); // ‡¶õ‡¶æ‡¶§‡ßç‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            break;
            
        case 'pay':
            renderAdminPayments(); // ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            break;
            
        case 'msg':
            renderAdminMessages(); // ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            break;
            
        case 'exam':
            renderAdminExams(); // ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            break;
            
        case 'post':
            renderAllPosts(); // ‡¶∏‡¶¨ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶°
            if (typeof renderCategories === 'function') {
                renderCategories(); // ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡ßã‡¶°
            }
            break;
            
        case 'lib':
            // ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶ö‡¶æ‡ßü
            renderLibrary(); 
            break;
            
        case 'set':
            renderConfig(); // ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá‡¶∞ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂/‡¶®‡¶ó‡¶¶ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞)
            if (typeof renderCategories === 'function') {
                renderCategories(); // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
            }
            break;
    }
}


        function showModal(id) {
            document.getElementById('modal-' + id).classList.remove('hidden');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.add('hidden');
            });
            
            if (TIMER_INT) {
                clearInterval(TIMER_INT);
                TIMER_INT = null;
            }
            
            ACTIVE_EXAM = null;
        }

        function copy(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        function searchStudents(query) {
            const filter = query.toUpperCase();
            const cards = document.getElementsByClassName('student-card');
            for (let i = 0; i < cards.length; i++) {
                const txt = cards[i].innerText;
                if (txt.toUpperCase().indexOf(filter) > -1) {
                    cards[i].style.display = "";
                } else {
                    cards[i].style.display = "none";
                }
            }
        }

        function logoutConfirm() {
            if (confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
                logout();
            }
        }

        function logout() {
            CURR_USER = null;
            localStorage.removeItem('mrds_user');
            localStorage.removeItem('mrds_pass');
            location.reload();
        }

        // ==================== EXAM FUNCTIONS ====================
   function startExamUI() {
    // 1. ‡¶ü‡¶æ‡¶á‡¶ü‡ßá‡¶≤ ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
    document.getElementById('runExamTitle').innerText = ACTIVE_EXAM.title;
    const examBody = document.getElementById('examBody');
    examBody.innerHTML = '';
    
    // 2. ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
    if (ACTIVE_EXAM.questions && ACTIVE_EXAM.questions.length > 0) {
        ACTIVE_EXAM.questions.forEach((q, i) => {
            let qContent = '';
            
            // ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶™ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá
            if (q.type === 'image') {
                qContent = `<div class="mb-2"><b>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}:</b></div><img src="${q.val}" class="q-img" style="max-width:100%; border-radius:8px;">`;
            } else {
                // Text ‡¶¨‡¶æ HTML/Math ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
                qContent = `<div class="mb-2"><b>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}:</b> <span class="math-content">${q.val}</span></div>`;
            }
            
            // ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶è‡¶ñ‡¶æ‡¶®‡ßá‡¶ì HTML/Math ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
            let optionsHTML = '';
            if (q.opts) {
                ['A', 'B', 'C', 'D'].forEach((letter, oi) => {
                    if (q.opts[oi]) { // ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶™‡¶∂‡¶®‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                        optionsHTML += `
                            <label class="mcq-opt">
                                <input type="radio" name="q${i}" value="${oi}">
                                <div class="math-content" style="width:100%;">
                                    <b>${letter}.</b> ${q.opts[oi]}
                                </div>
                            </label>
                        `;
                    }
                });
            }
            
            // ‡¶Æ‡ßÇ‡¶≤ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶§‡ßà‡¶∞‡¶ø
            examBody.innerHTML += `
                <div class="card" id="q-${i}">
                    ${qContent}
                    <div class="mt-2">${optionsHTML}</div>
                </div>
            `;
        });
    } else {
        examBody.innerHTML = '<p class="text-center">No questions available</p>';
    }
    
    // 3. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶æ
    document.getElementById('modal-exam').classList.remove('hidden');
    
    // 4. ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡¶æ
    let timeLeft = (ACTIVE_EXAM.dur || 60) * 60;
    updateTimerDisplay(timeLeft);
    if (TIMER_INT) clearInterval(TIMER_INT);
    
    TIMER_INT = setInterval(() => {
        timeLeft--;
        updateTimerDisplay(timeLeft);
        if (timeLeft <= 0) {
            clearInterval(TIMER_INT);
            submitExam();
        }
    }, 1000);

    // 5. MathJax ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶æ‡¶§‡ßá ‡¶Ö‡¶™‡¶∂‡¶®‡ßá‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶•‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡ßü)
    if (window.MathJax) {
        // ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡ßü‡ßá ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá DOM ‡¶∞‡ßá‡¶°‡¶ø ‡¶•‡¶æ‡¶ï‡ßá
        setTimeout(() => {
            MathJax.typesetPromise().then(() => {
                console.log('MathJax rendering complete');
            }).catch((err) => console.log('MathJax error:', err));
        }, 100);
    }
}


        function startExamUI() {
            document.getElementById('runExamTitle').innerText = ACTIVE_EXAM.title;
            const examBody = document.getElementById('examBody');
            examBody.innerHTML = '';
            
            if (ACTIVE_EXAM.questions && ACTIVE_EXAM.questions.length > 0) {
                ACTIVE_EXAM.questions.forEach((q, i) => {
                    let qContent = '';
                    
                    if (q.type === 'image') {
                        qContent = `<div class="mb-2"><b>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}:</b></div><img src="${q.val}" class="q-img" style="max-width:100%; border-radius:8px;">`;
                    } else if (q.type === 'html') {
                        qContent = `<div class="mb-2"><b>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}:</b> <span class="math-content">${q.val}</span></div>`;
                    } else {
                        qContent = `<div class="mb-2"><b>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ${i + 1}:</b> ${q.val}</div>`;
                    }
                    
                    let optionsHTML = '';
                    if (q.opts) {
                        ['A', 'B', 'C', 'D'].forEach((letter, oi) => {
                            if (q.opts[oi]) {
                                optionsHTML += `
                                    <label class="mcq-opt">
                                        <input type="radio" name="q${i}" value="${oi}">
                                        <div class="math-content"><b>${letter}.</b> ${q.opts[oi]}</div>
                                    </label>
                                `;
                            }
                        });
                    }
                    
                    examBody.innerHTML += `
                        <div class="card" id="q-${i}">
                            ${qContent}
                            <div class="mt-2">${optionsHTML}</div>
                        </div>
                    `;
                });
            } else {
                examBody.innerHTML = '<p class="text-center">No questions available</p>';
            }
            
            document.getElementById('modal-exam').classList.remove('hidden');
            
            let timeLeft = (ACTIVE_EXAM.dur || 60) * 60;
            updateTimerDisplay(timeLeft);
            if (TIMER_INT) clearInterval(TIMER_INT);
            TIMER_INT = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(TIMER_INT);
                    submitExam();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            document.getElementById('timerDisplay').innerText = 
                `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
// ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
async function deleteExam(id) {
    if (!confirm("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶è‡¶ü‡¶ø ‡¶™‡¶æ‡¶∞‡ßç‡¶Æ‡¶æ‡¶®‡ßá‡¶®‡ßç‡¶ü‡¶≤‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!")) {
        return;
    }

    try {
        // ‡ßß. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ
        await db.ref('exams/' + id).remove();
        
        // ‡ß®. ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã‡¶ì ‡¶ï‡ßç‡¶≤‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)
        // ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶æ‡¶§‡¶§ ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
        
        alert("‚úÖ ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        
        // ‡ß©. ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ
        renderAdminExams(); // ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂
        renderExams();      // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂

    } catch (error) {
        console.error("Delete Error:", error);
        alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø: " + error.message);
    }
}

    // ==================== SUBMIT EXAM FUNCTION ====================
async function submitExam() {
    // ‡ßß. ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶ì ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤‡¶ø‡¶Ç
    if (TIMER_INT) {
        clearInterval(TIMER_INT);
        TIMER_INT = null;
    }
    
    const submitBtn = document.querySelector('#modal-exam .btn-success');
    if(submitBtn) {
        submitBtn.innerText = "Processing...";
        submitBtn.disabled = true;
    }

    if (!ACTIVE_EXAM) return;

    // ‡ß®. ‡¶∏‡ßç‡¶ï‡ßã‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
    let score = 0;
    const total = ACTIVE_EXAM.questions ? ACTIVE_EXAM.questions.length : 0;
    let userAnswers = [];
    
    if (total > 0) {
        ACTIVE_EXAM.questions.forEach((q, i) => {
            const selected = document.querySelector(`input[name="q${i}"]:checked`);
            let userAns = -1;
            if (selected) userAns = parseInt(selected.value);
            userAnswers.push(userAns);
            if (userAns === parseInt(q.ans)) score++;
        });
    }
    
    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;

    // ‡ß©. ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ö‡¶¨‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø
    const resultData = {
        uid: CURR_USER.id,
        eid: ACTIVE_EXAM.id,
        score: score,
        total: total,
        percentage: percentage,
        userAnswers: userAnswers,
        timestamp: Date.now()
    };

    try {
        // ‡ß™. ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
        await db.ref('results').push(resultData);
        
        // ‡ß´. ‡¶ó‡¶ø‡¶´‡¶ü ‡¶≤‡¶ú‡¶ø‡¶ï
        if (ACTIVE_EXAM.giftAmount > 0) {
            const newBalance = CURR_USER.bal + ACTIVE_EXAM.giftAmount;
            await db.ref('users/' + CURR_USER.id + '/bal').set(newBalance);
            CURR_USER.bal = newBalance;
            await db.ref('gifts').push({
                uid: CURR_USER.id,
                eid: ACTIVE_EXAM.id,
                amount: ACTIVE_EXAM.giftAmount,
                reason: 'Exam Reward',
                timestamp: Date.now()
            });
        }

        // ======================================================
        // üî• ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ (FORCE REFRESH) üî•
        // ======================================================
        
        // ‡ßß. ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü (‡¶Ø‡¶æ‡¶§‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü‡ßá‡¶∞ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡ßü)
        if (!DB_DATA.results) DB_DATA.results = {};
        // ‡¶è‡¶ï‡¶ü‡¶ø ‡¶á‡¶â‡¶®‡¶ø‡¶ï ‡¶ï‡¶ø (Key) ‡¶¶‡¶ø‡ßü‡ßá ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü‡¶ü‡¶ø ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶õ‡¶ø
        const tempKey = "temp_" + Date.now();
        DB_DATA.results[tempKey] = resultData;
        
        // ‡ß®. ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        if(DB_DATA.users && DB_DATA.users[CURR_USER.id]) {
            DB_DATA.users[CURR_USER.id].bal = CURR_USER.bal;
        }

        alert(`‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá!\n‡¶∏‡ßç‡¶ï‡ßã‡¶∞: ${score}/${total}`);
        
        // ‡ß©. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡¶æ
        closeModal();
        ACTIVE_EXAM = null;
        
        // ‡ß™. UI ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ (‡¶ñ‡ßÅ‡¶¨‡¶á ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£)
        updateUserUI(); // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
        
        // ‡ß´. ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ú‡ßã‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ
        // ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶∏‡¶Æ‡ßü ‡¶®‡¶ø‡ßü‡ßá ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá DOM ‡¶∞‡ßá‡¶°‡¶ø ‡¶•‡¶æ‡¶ï‡ßá
        setTimeout(() => {
            renderExams(); 
        }, 100);

    } catch (error) {
        console.error("Submit Error:", error);
        alert("‡¶è‡¶∞‡¶∞: " + error.message);
    } finally {
        if(submitBtn) {
            submitBtn.innerText = "Submit";
            submitBtn.disabled = false;
        }
    }
}


    </script>
</body>
</html>